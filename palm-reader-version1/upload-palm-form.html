<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hast Rekha</title>
    <link rel="icon" href="./images/logo.svg" type="image/x-icon">
    <!-- link to css -->
    <link rel="stylesheet" href="style.css">
    <!-- link to jbootstrap -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <!-- link to jquery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- link to bootstrap -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- link to popper -->
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
    <!-- link to bootstrap -->
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<!-- Meta Pixel Code -->
<script>
    !function(f,b,e,v,n,t,s)
    {if(f.fbq)return;n=f.fbq=function(){n.callMethod?
    n.callMethod.apply(n,arguments):n.queue.push(arguments)};
    if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
    n.queue=[];t=b.createElement(e);t.async=!0;
    t.src=v;s=b.getElementsByTagName(e)[0];
    s.parentNode.insertBefore(t,s)}(window, document,'script',
    'https://connect.facebook.net/en_US/fbevents.js');
    fbq('init', '2372650349848184');
    fbq('track', 'PageView');
    </script>
    <noscript><img height="1" width="1" style="display:none"
    src="https://www.facebook.com/tr?id=2372650349848184&ev=PageView&noscript=1"
    /></noscript>
    <!-- End Meta Pixel Code -->
</head>
<body>
    <div class="wrapper-form">
    <div class="container-fluid ">
        <div class="row justify-content-center">
            <div class="col-md-4">
                <h1 class="my-3 text-white">Tell Us About Your</h1>
                <p class="text-white fs-14 mt-3 mb-5">
                    We need some details to create your personalized reading.
                </p>
                <form id="palmForm">
                    <div class="mb-3 form-group">
                        <label for="name" class="form-label">Name</label>
                        <input type="text" class="form-control" id="name" name="name" required>
                    </div>
                    
                    <div class="mb-3 form-group">
                        <label for="phone" class="form-label">Phone</label>
                        <input type="number" class="form-control" id="phone" name="phone"  required>
                        <div class="error-message" id="phoneError" style="display: none;"></div>
                    </div>
                    
                    <div class="mb-3 form-group">
                        <label for="palmImage" class="form-label">Palm Image (Right Hand)</label>
                        <div class="upload-box-container">
                            <div class="upload-box" id="uploadBox">
                                <input type="file" class="form-control d-none" id="palmImage" name="palmImage" accept="image/*">
                                <label for="palmImage" class="upload-label">
                                    <div class="upload-icon">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" class="bi bi-cloud-upload" viewBox="0 0 16 16">
                                            <path fill-rule="evenodd" d="M4.406 1.342A5.53 5.53 0 0 1 8 0c2.69 0 4.923 2 5.166 4.579C14.758 4.804 16 6.137 16 7.773 16 9.569 14.502 11 12.687 11H10a.5.5 0 0 1 0-1h2.688C13.979 10 15 8.988 15 7.773c0-1.216-1.02-2.228-2.313-2.228h-.5v-.5C12.188 2.825 10.328 1 8 1a4.53 4.53 0 0 0-2.941 1.1c-.09.13-.194.25-.308.358l-.353.353-.353-.354a4.53 4.53 0 0 0-.308-.358A4.53 4.53 0 0 0 3.5 1.5c-1.657 0-3 1.343-3 3 0 1.31 1.05 2.38 2.406 2.542z"/>
                                            <path fill-rule="evenodd" d="M7.646 4.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 5.707V14.5a.5.5 0 0 1-1 0V5.707L5.354 7.854a.5.5 0 1 1-.708-.708z"/>
                                        </svg>
                                    </div>
                                    <div class="upload-text">
                                        <span class="upload-main-text">Click to upload</span>
                                    </div>
                                </label>
                            </div>
                            <div class="image-preview" id="imagePreview" style="display: none;">
                                <div class="d-flex align-items-center justify-content-center">
                                <img id="previewImage" src="" alt="Palm preview" class="preview-img">
                                </div>
                                <button type="button" class="btn-remove-preview" id="removePreview" title="Remove image">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-x-circle" viewBox="0 0 16 16">
                                        <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14m0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16"/>
                                        <path d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708"/>
                                    </svg>
                                </button>
                            </div>
                        </div>
                        <div class="error-message" id="imageError" style="display: none;"></div>
                    </div>
                    
                    <button type="submit" class="btn btn-primary-custom w-100" id="submitBtn">
                        <span id="submitBtnText">Submit</span>
                        <span id="submitBtnSpinner" class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>
    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyD4IQwokYy02_2SQxah0HC9fIHRPxoxoEg",
            authDomain: "palm-reader-7f6b4.firebaseapp.com",
            projectId: "palm-reader-7f6b4",
            storageBucket: "palm-reader-7f6b4.firebasestorage.app",
            messagingSenderId: "277530875490",
            appId: "1:277530875490:web:88b810a4ef964434f2a33b"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // Configuration
        const storageUrl = 'https://sg.storage.bunnycdn.com/fable';
        const acessKey = '63415b40-6b61-4dd8-ad0cce4b91f3-5c97-481c';
        const storageAcessUrl = 'https://fable.b-cdn.net';

        // Convert file to binary (ArrayBuffer)
        function convertFileToBinary(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                
                reader.onload = () => {
                    resolve(reader.result);
                };
                
                reader.onerror = () => {
                    reject(new Error('Failed to read file'));
                };
                
                reader.readAsArrayBuffer(file);
            });
        }

        // Upload image to BunnyCDN Storage
        async function uploadImage(file, filePath) {
            try {
                const binaryData = await convertFileToBinary(file);
                
                const response = await fetch(`${storageUrl}${filePath}`, {
                    method: 'PUT',
                    headers: {
                        'AccessKey': acessKey,
                        'Content-Type': 'application/octet-stream'
                    },
                    body: binaryData
                });
                
                // Check if upload was successful
                if (response.status === 201 || response.ok) {
                    return {
                        path: filePath,
                        url: `${storageAcessUrl}${filePath}`
                    };
                } else {
                    const errorText = await response.text();
                    throw new Error(`Failed to upload image. Status: ${response.status}, ${errorText}`);
                }
            } catch (error) {
                console.error('Error uploading image:', error);
                throw error;
            }
        }

        // Get URL query parameters
        function getUrlQueryParams() {
            const params = {};
            const urlParams = new URLSearchParams(window.location.search);
            
            for (const [key, value] of urlParams.entries()) {
                params[key] = value;
            }
            
            return params;
        }

        // Save form data to Firestore
        async function saveFormDataToFirebase(formDataObject) {
            try {
                const docRef = await db.collection('palmReadings').add(formDataObject);
                console.log('Document written with ID: ', docRef.id);
                return { id: docRef.id, ...formDataObject };
            } catch (error) {
                console.error('Error saving to Firebase:', error);
                throw error;
            }
        }

        // Phone number validation - ensure exactly 10 digits
        const phoneInput = document.getElementById('phone');
        const phoneError = document.getElementById('phoneError');
        
        phoneInput.addEventListener('input', function(e) {
            let value = e.target.value;
            
            // Remove any non-digit characters
            value = value.replace(/\D/g, '');
            
            // Limit to 10 digits
            if (value.length > 10) {
                value = value.substring(0, 10);
            }
            
            e.target.value = value;
            
            // Hide error when user is typing
            if (phoneError) {
                phoneError.style.display = 'none';
                phoneInput.classList.remove('is-invalid');
            }
        });
        
        // Validate phone on blur
        phoneInput.addEventListener('blur', function(e) {
            const value = e.target.value;
            if (value && value.length !== 10) {
                if (phoneError) {
                    phoneError.textContent = 'Phone number must be exactly 10 digits';
                    phoneError.style.display = 'block';
                    phoneInput.classList.add('is-invalid');
                }
            } else {
                if (phoneError) {
                    phoneError.style.display = 'none';
                    phoneInput.classList.remove('is-invalid');
                }
            }
        });
        
        // Image preview handler
        document.getElementById('palmImage').addEventListener('change', function(e) {
            const file = e.target.files[0];
            const uploadBox = document.getElementById('uploadBox');
            const imagePreview = document.getElementById('imagePreview');
            const previewImage = document.getElementById('previewImage');
            
            if (file) {
                // Check if file is an image
                if (!file.type.startsWith('image/')) {
                    Swal.fire({
                        icon: 'error',
                        title: 'Invalid File',
                        text: 'Please select an image file',
                        confirmButtonColor: '#FDD513',
                        confirmButtonText: 'OK'
                    });
                    e.target.value = '';
                    return;
                }
                
                // Create a FileReader to read the file
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    previewImage.src = e.target.result;
                    uploadBox.style.display = 'none';
                    imagePreview.style.display = 'block';
                    
                    // Hide error message when image is selected
                    const imageError = document.getElementById('imageError');
                    if (imageError) {
                        imageError.style.display = 'none';
                    }
                    if (uploadBox) {
                        uploadBox.style.borderColor = '';
                    }
                };
                
                reader.onerror = function() {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: 'Error reading file. Please try again.',
                        confirmButtonColor: '#FDD513',
                        confirmButtonText: 'OK'
                    });
                };
                
                reader.readAsDataURL(file);
            } else {
                uploadBox.style.display = 'block';
                imagePreview.style.display = 'none';
            }
        });
        
        // Remove preview handler
        document.getElementById('removePreview').addEventListener('click', function() {
            const fileInput = document.getElementById('palmImage');
            const uploadBox = document.getElementById('uploadBox');
            const imagePreview = document.getElementById('imagePreview');
            const previewImage = document.getElementById('previewImage');
            
            fileInput.value = '';
            previewImage.src = '';
            uploadBox.style.display = 'block';
            imagePreview.style.display = 'none';
        });

        // Form submit handler
        document.getElementById('palmForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const submitBtn = document.getElementById('submitBtn');
            const submitBtnText = document.getElementById('submitBtnText');
            const submitBtnSpinner = document.getElementById('submitBtnSpinner');
            const removePreviewBtn = document.getElementById('removePreview');
            
            // Hide remove preview button
            if (removePreviewBtn) {
                removePreviewBtn.style.display = 'none';
            }
            
            const formData = new FormData(this);
            const name = formData.get('name');
            const phone = formData.get('phone');
            const palmImage = formData.get('palmImage');
            
            // Console log form data
            console.log('Form Data:');
            console.log('Name:', name);
            console.log('Phone:', phone);
            console.log('Palm Image:', palmImage);
            
            // Validate phone number
            const phoneValue = phone ? phone.toString() : '';
            if (!phoneValue || phoneValue.length !== 10) {
                if (phoneError) {
                    phoneError.textContent = 'Phone number must be exactly 10 digits';
                    phoneError.style.display = 'block';
                    phoneInput.classList.add('is-invalid');
                    phoneInput.focus();
                }
                // Show remove preview button again on validation error
                if (removePreviewBtn) {
                    removePreviewBtn.style.display = 'block';
                }
                return;
            } else {
                if (phoneError) {
                    phoneError.style.display = 'none';
                    phoneInput.classList.remove('is-invalid');
                }
            }
            
            // Validate file was selected
            const imageError = document.getElementById('imageError');
            const uploadBox = document.getElementById('uploadBox');
            
            if (!palmImage || palmImage.size === 0) {
                console.error('Please select a palm image');
                if (imageError) {
                    imageError.textContent = 'Please select a palm image';
                    imageError.style.display = 'block';
                }
                if (uploadBox) {
                    uploadBox.style.borderColor = '#ff6b6b';
                }
                // Show remove preview button again on validation error
                if (removePreviewBtn) {
                    removePreviewBtn.style.display = 'block';
                }
                return;
            } else {
                // Hide error if image is selected
                if (imageError) {
                    imageError.style.display = 'none';
                }
                if (uploadBox) {
                    uploadBox.style.borderColor = '';
                }
            }
            
            // Show loading state
            submitBtn.disabled = true;
            submitBtnText.textContent = 'Submitting...';
            submitBtnSpinner.classList.remove('d-none');
            
            try {
                // Get file extension from original filename
                const fileName = palmImage.name;
                const fileExtension = fileName.split('.').pop() || 'jpg';
                const path = `/palms/${name}.${fileExtension}`;
                
                console.log('Uploading image...');
                const uploadResult = await uploadImage(palmImage, path);
                console.log('Upload successful:', uploadResult);
                
                // Get URL query parameters
                const queryParams = getUrlQueryParams();
                console.log('URL Query Parameters:', queryParams);
                
                // Create form data object with createdAt and query parameters
                const formDataObject = {
                    name: name,
                    phone: phone,
                    palmImage: uploadResult,
                    createdAt: new Date().toISOString(),
                    ...queryParams  // Spread query parameters into the object
                };
                
                // Console log the form data object
                console.log('Form Data Object:', formDataObject);
                
                // Save to Firebase
                console.log('Saving to Firebase...');
                const firebaseResult = await saveFormDataToFirebase(formDataObject);
                console.log('Data saved to Firebase:', firebaseResult);
                //reset the form
                document.getElementById('palmForm').reset();
                //remove the image preview
                const imagePreview = document.getElementById('imagePreview');
                imagePreview.style.display = 'none';
                //remove the upload box
                const uploadBox = document.getElementById('uploadBox');
                uploadBox.style.display = 'block';
                //submit button text
                submitBtnText.textContent = 'Submit';
                //submit button spinner
                submitBtnSpinner.classList.add('d-none');
                
                // Redirect to listing page
                window.location.href = 'form-successful.html';
            } catch (error) {
                console.error('Error:', error);
                
                // Reset button state on error
                submitBtn.disabled = false;
                submitBtnText.textContent = 'Submit';
                submitBtnSpinner.classList.add('d-none');
                
                // Show remove preview button again on error
                if (removePreviewBtn) {
                    removePreviewBtn.style.display = 'block';
                }
                
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: error.message || 'An error occurred. Please try again.',
                    confirmButtonColor: '#FDD513',
                    confirmButtonText: 'OK'
                });
            }
        });
    </script>
</body>
</html>