{% extends 'Admin/admin-base.html' %}
{% block title %}Dashboard{% endblock %}
{% block css %}


<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.13.1/css/jquery.dataTables.min.css">
<link href="https://cdn.datatables.net/2.2.1/css/dataTables.bootstrap5.min.css" rel="stylesheet">
{# <link rel="stylesheet" href="https://cdn.datatables.net/select/3.0.0/css/select.dataTables.css" type="text/css"> #}
{# <link rel="stylesheet" href="https://cdn.datatables.net/buttons/3.2.0/css/buttons.dataTables.css" type="text/css"> #}
<link href="https://cdn.datatables.net/buttons/3.2.0/css/buttons.bootstrap5.min.css" rel="stylesheet">
<link href="https://cdn.datatables.net/searchpanes/2.3.3/css/searchPanes.bootstrap5.min.css" rel="stylesheet">
<link href="https://cdn.datatables.net/responsive/3.0.3/css/responsive.bootstrap5.min.css" rel="stylesheet">


{% endblock %}
{% block body %}
{% embed "Admin/admin-header.twig" %}{% endembed %}
<section class="stats my-5">
    <div class="container">
        <div class="row justify-content-center">
            {# Total #}
            <div class="col-12 col-md-2">
                <div class="card mb-3 border-0 shadow-purple-sm">
                    <div class="row g-0">
                        {# <div class="col-4">
                            <img src="{{ env.rootfolder }}img/stats1.jpg" class="img-fluid rounded-start" alt="...">
                        </div> #}
                        <div class="col-12">
                            <div class="card-header border-0 rounded-0 text-uppercase">
                                Total Entries
                            </div>
                            <div class="card-body">
                                <p class="card-text">{{ total }}</p>
                                {# <p class="card-text"><small class="text-muted">Last updated 3 mins ago</small></p> #}
                            </div>
                        </div>
                    </div>
                </div>
            </div>


            {# Paid #}
            <div class="col-12 col-md-2">
                <a href="{{env.adminfolder}}dashboard?filter=completed" class="text-decoration-none">
                    <div class="card mb-3 border-0 shadow-purple-sm">
                        <div class="row g-0">
                            {# <div class="col-4">
                            <img src="{{ env.rootfolder }}img/stats3.jpg" class="img-fluid rounded-start" alt="...">
                        </div> #}
                            <div class="col-12">
                                <div class="card-header border-0 rounded-0 text-uppercase">
                                    Paid <small>(Filter)</small>
                                </div>
                                <div class="card-body">
                                    <p class="card-text">{{ paid }}</p>
                                    {# <p class="card-text"><small class="text-muted">Last updated 3 mins ago</small></p> #}
                                </div>
                            </div>
                        </div>
                    </div>
                </a>
            </div>

            {# Unpaid #}
            <div class="col-12 col-md-2">
                <a href="{{env.adminfolder}}dashboard?filter=pending" class="text-decoration-none">
                    <div class="card mb-3 border-0 shadow-purple-sm">
                        <div class="row g-0">
                            {# <div class="col-4">
                            <img src="{{ env.rootfolder }}img/stats3.jpg" class="img-fluid rounded-start" alt="...">
                        </div> #}
                            <div class="col-12">
                                <div class="card-header border-0 rounded-0 text-uppercase">
                                    Unpaid <small>(Filter)</small>
                                </div>
                                <div class="card-body">
                                    <p class="card-text">{{ unpaid }}</p>
                                    {# <p class="card-text"><small class="text-muted">Last updated 3 mins ago</small></p> #}
                                </div>
                            </div>
                        </div>
                    </div>
                </a>
            </div>

            {# Today #}
            <div class="col-12 col-md-2">
                <div class="card mb-3 border-0 shadow-purple-sm">
                    <div class="row g-0">
                        {# <div class="col-4">
                            <img src="{{ env.rootfolder }}img/stats2.jpg" class="img-fluid rounded-start" alt="...">
                        </div> #}
                        <div class="col-12">
                            <div class="card-header border-0 rounded-0 text-uppercase">
                                Entries Today
                            </div>
                            <div class="card-body">
                                <p class="card-text">{{ today }}</p>
                                {# <p class="card-text"><small class="text-muted">Last updated 3 mins ago</small></p> #}
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            {# 7 Days #}
            <div class="col-12 col-md-2">
                <div class="card mb-3 border-0 shadow-purple-sm">
                    <div class="row g-0">
                        {# <div class="col-4">
                            <img src="{{ env.rootfolder }}img/stats3.jpg" class="img-fluid rounded-start" alt="...">
                        </div> #}
                        <div class="col-12">
                            <div class="card-header border-0 rounded-0 text-uppercase">
                                Last 7 days
                            </div>
                            <div class="card-body">
                                <p class="card-text">{{ week }}</p>
                                {# <p class="card-text"><small class="text-muted">Last updated 3 mins ago</small></p> #}
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>
</section>
<section class="leadsdata">
    <div class="container">
        <div class="row">
            <nav class="navbar navbar-expand-lg navbar-light bg-light">
                <div class="container-fluid p-0">
                    <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                        {# <li class="nav-item me-md-2 align-self-center">User:</li>
                        <li class="nav-item me-md-4">
                            <form>
                                <select class="form-select insidetable " id="type-filter" name="type-filter">
                                    <option value="" {{ userRef is empty ? "selected" : ""}}>
                                        All
                                    </option>
                                    {% for u in users %}
                                    <option value="{{u.ureferral_code}}"
                                        {{ userRef == u.ureferral_code ? "selected" : ""}}>
                                        {{u.uname is not empty ? u.uname|title : u.uphone}}
                                    </option>
                                    {% endfor %}
                                </select>
                            </form>
                        </li> #}
                        <li class="nav-item me-md-2 align-self-center ">From:</li>

                        <li class="nav-item me-md-4">
                            <input type="date" class="form-control from" value="{% if session.from is defined %}{{ session.from }}{% endif %}" />
                        </li>
                        <li class="nav-item me-md-2 align-self-center">To:</li>
                        <li class="nav-item me-md-2">
                            <input type="date" class="form-control to" value="{% if session.to is defined %}{{ session.to }}{% endif %}" />
                        </li>
                        <li class="nav-item me-md-2 align-self-center">
                            <a href="javascript:void(0)" class="btn btn-dark-purple datefilter">
                                <i class="bi bi-check-lg"></i>
                            </a>
                        </li>

                    </ul>
                    <ul class="navbar-nav ms-auto mb-2 mb-lg-0">

                        {% if get.filter is defined and get.filter is not empty %}
                        <li class="nav-item me-2">
                            <a class="btn btn-dark-purple" href="{{ env.adminfolder }}dashboard"><i class="bi bi-arrow-counterclockwise me-2"></i>Show All</a>
                        </li>
                        {% endif %}

                        <li class="nav-item">
                            <a class="btn btn-dark-purple" aria-current="page" href="{{ env.adminfolder }}download/entries" target="_blank"><i class="bi bi-download me-2"></i>Export Excel</a>
                        </li>

                        {# <li class="nav-item">
                            <a class="btn btn-dark-purple ms-2" aria-current="page" href="{{ env.adminfolder }}download/json" target="_blank"><i class="bi bi-download me-2"></i>Export JSON</a>
                        </li> #}
                    </ul>
                </div>
            </nav>
        </div>
        <div class="row p-0">
            <div class="col-12 p-0">
                <div class="card border-0 shadow-purple-sm">
                    <div class="card-body">
                        {# filter pills #}
                        {% if session.statusfilter is defined %}
                        <span class="badge rounded-pill bg-light text-dark">{{ session.statusfilter|capitalize|replace({'-': ' '}) }}
                            <a href="javascript:void(0)" class="delstatusfilter text-dark" title="Clear Status Filter"><i class="bi bi-x-circle"></i></a></span>
                        {% endif %}
                        {% if session.from is defined %}
                        <span class="badge rounded-pill bg-light text-dark">{{ session.from }} - {{ session.to }} <a href="javascript:void(0)" class="deldatefilter text-dark" title="Clear Date Filter"><i class="bi bi-x-circle"></i></a></span>
                        {% endif %}
                        {# filter pills #}

                        <div class="table-responsive">

                            <table id="leads" class="table mb-0">
                                <thead>
                                    <tr>
                                        <th>#</th>
                                        <th>Name</th>
                                        <th>Phone</th>
                                        <th>Email</th>
                                        <th>City</th>
                                        <th>Order ID</th>
                                        <th>Merchant Transaction ID</th>
                                        <th>PhonePe Transaction ID</th>
                                        <th>User ID</th>
                                        <th>Amount</th>
                                        <th>Status</th>
                                        <th>Payment Method</th>
                                        <th>Timestamp</th>
                                        <th>Action</th>
                                    </tr>
                                </thead>


                                <tbody>
                                    {% for leads in data %}
                                    <tr id="table-row-{{leads.vid}}">
                                        <td>{{ leads.eid|default('-') }}</td>
                                        <td class="{% if leads.status|lower == 'pending' %}text-warning{% elseif leads.status|lower == 'completed' %}text-success{% elseif leads.status|lower == 'failed' %}text-danger{% else %}text-dark{% endif %}">
                                            {{ leads.ename|default('-') }}
                                        </td>
                                        <td><a href="tel:+91-{{leads.ephone}}" class="text-reset text-decoration-none">{{ leads.ephone|default('-') }}</a></td>
                                        <td>{{ leads.eemail|default('-') }}</td>
                                        <td>{{ leads.ecity|default('-') }}</td>
                                        <td>{{ leads.order_id|default('-') }}</td>
                                        <td>{{ leads.merchant_transaction_id|default('-') }}</td>
                                        <td>{{ leads.phonepe_transaction_id|default('-') }}</td>
                                        <td>{{ leads.user_id|default('-') }}</td>
                                        <td>{{ leads.amount|default('-') }}</td>
                                        <td>{{ leads.status|default('-') }}</td>
                                        <td>{{ leads.payment_method|default('-') }}</td>
                                        <td>{{ leads.etstamp|default('-') }}</td>
                                        <td>
                                            {% if leads.status|lower == 'pending' %}
                                            <button type="button" class="btn btn-primary check-status" data-mt="{{ leads.merchant_transaction_id }}">Check Status</button>
                                            {% else %}
                                            <button class="btn btn-light text-dark" disabled data-bs-toggle="tooltip" title="Status is already checked">Check Status</button>

                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% endfor %}
                                <tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Modal -->
<div class="modal fade" id="commentsmodal" tabindex="-1" aria-labelledby="commentstitle" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="commentstitle">Comments</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p class="editablecomment" contenteditable="true">Click to edit</p>
            </div>
        </div>
    </div>
</div>
{% embed "Admin/admin-footer.twig" %}{% endembed %}
{% endblock %}

{% block scripts %}

<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
<script src="https://cdn.datatables.net/1.13.1/js/jquery.dataTables.min.js" type="text/javascript"></script>



<script src="https://cdn.datatables.net/2.2.1/js/dataTables.min.js"></script>
<script src="https://cdn.datatables.net/2.2.1/js/dataTables.bootstrap5.min.js"></script>
<script src="https://cdn.datatables.net/buttons/3.2.0/js/dataTables.buttons.min.js"></script>
<script src="https://cdn.datatables.net/buttons/3.2.0/js/buttons.bootstrap5.min.js"></script>
{# <script src="https://cdn.datatables.net/buttons/3.2.0/js/buttons.colVis.min.js"></script> #}
<script src="https://cdn.datatables.net/responsive/3.0.3/js/dataTables.responsive.min.js"></script>
<script src="https://cdn.datatables.net/responsive/3.0.3/js/responsive.bootstrap5.js"></script>
<script src="https://cdn.datatables.net/searchpanes/2.3.3/js/dataTables.searchPanes.min.js"></script>
<script src="https://cdn.datatables.net/select/3.0.0/js/dataTables.select.js"></script>
<script src="https://cdn.datatables.net/searchpanes/2.3.3/js/searchPanes.bootstrap5.min.js"></script>
<script>

    $(document).ready(function () {

        var lastActionColumn = $('#leads thead th').length - 1;

        $('#leads').DataTable({
            responsive: true,
            order: [0, 'desc'],

            /* columnDefs: [
                {
                    orderable: false,
                    targets: [lastActionColumn]
                },
                {
                    targets: 0,
                    visible: false
                },
                // { "defaultContent": "-", "targets": "_all" },
            ],

            dom: 'Pfrtip',

            searchPanes: {
                columns: [10],
                initCollapsed: true,
                orderable: false,
                viewTotal: true
            },

            // buttons: [
            //     'columnsToggle'
            // ] */

            columnDefs: [
                {
                    orderable: false,
                    targets: [lastActionColumn]
                },
                {
                    targets: 0,
                    visible: false
                },
                { "defaultContent": "-", "targets": "_all" },
                // {
                //     searchPanes: {
                //         className: 'status-filter-pane'
                //     },
                //     targets: 10
                // },
            ],

            // layout: {
            //     top1: 'searchPanes'
            // },

            // searchPanes: {
            //     columns: [1, 2, 7],
            //     initCollapsed: true,
            //     orderable: false,
            // },
            // initComplete: function (settings, json) {
            //     // Check if any search panes are visible
            //     if ($('.dtsp-panesContainer .dtsp-searchPane').length === 0) {
            //         // Hide the search pane container if no panes are available
            //         $('.dtsp-panesContainer').parentsUntil('row').remove();
            //     }
            // }
        });
    });


    // check status
    $("body").on('click', '.check-status', function (event) {

        // show loader when btn is clicked
        $(this).html('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Checking...').attr('disabled', true);


        var mt = $(this).data('mt');
        var thi = $(this);
        const params = new URLSearchParams({ mt: mt });
        axios.post('{{ env.rootfolder }}payment/status-check?mt=' + mt, params, {
            responseType: 'json',
        })
            .then(function (response) {
                if (response.status === 200) {
                    window.location.reload();
                }
            })
            .catch(function (error) {
                console.log(error);
                // hide loader
                $(thi).html('Check Status').attr('disabled', false);
            });
    });




    // Data Filter
    $("body").on('change', '#type-filter', function (event) {
        // event.preventDefault();
        var userRef = $(this).val();
        console.log(userRef);

        if (userRef != 'All') {
            window.location.href = window.location.href.replace(/[\?#].*|$/, "?userRef=" + userRef);
        } else {
            window.location.href = location.protocol + '//' + location.host + location.pathname;
        }
    });


    // delete lead
    $("body").on('click', '.deleteBtn', function (event) {
        var thi = $(this);
        var id = $(this).data('id');
        var parentrow = '#table-row-' + $(this).data('id');
        Swal.fire({
            title: 'Are you sure?',
            text: "You won't be able to revert this!",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#d33',
            confirmButtonText: 'Yes, delete it!'
        }).then((result) => {
            if (result.isConfirmed) {
                const params = new URLSearchParams({ id: id });
                axios.post('{{env.rootfolder}}ajaxcalls/leads/delete', params, {
                    responseType: 'json',
                })
                    .then(function (response) {
                        if (response.data === 'success') {
                            Swal.fire(
                                'Deleted!',
                                'Your Lead has been deleted.',
                                'success'
                            ),
                                $(thi).closest('tr').slideUp("normal ", function () {
                                    $(this).remove();
                                });
                        }
                    })
                    .catch(function (error) {
                        console.log(error);
                    });
            }
        })
    });

    document.addEventListener("paste", function (e) {
        // cancel paste
        e.preventDefault();

        // get text representation of clipboard
        var text = (e.originalEvent || e).clipboardData.getData('text/plain');

        // insert text manually
        document.execCommand("insertHTML", false, text);
    });


    var statusfilter = document.querySelector('.datefilter');
    statusfilter.addEventListener('click', function () {
        var from = document.querySelector('.from').value;
        var to = document.querySelector('.to').value;

        if (from == null || from == "", to == null || to == "") {
            Toastify({
                text: "Dates cannot be empty",
                duration: 3000,
                close: true,
                gravity: "bottom", // `top` or `bottom`
                position: "center", // `left`, `center` or `right`
                stopOnFocus: true, // Prevents dismissing of toast on hover
                style: {
                    background: "#ff0000",
                },
                onClick: function () { } // Callback after click
            }).showToast();
        } else {
            var data = "from=" + from + "&to=" + to;
            var request = new XMLHttpRequest();
            request.open('POST', 'ajaxcalls/filter/date', true);
            request.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded; charset=UTF-8');
            request.send(data);
            request.onreadystatechange = function () {
                if (request.readyState === 4 && request.status == 200) {
                    window.location.reload();
                }
            };
        }
    });

    // delete status filter
    document.addEventListener('click', function (e) {
        if (e.target.parentElement.classList.contains("deldatefilter")) {
            var request = new XMLHttpRequest();
            request.open('POST', 'ajaxcalls/filter/deletedate', true);
            request.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded; charset=UTF-8');
            request.send();
            request.onreadystatechange = function () {
                if (request.readyState === 4 && request.status == 200) {
                    window.location.reload();
                }
            };
        }


    });
    // FILTERS //




</script>
{% endblock %}