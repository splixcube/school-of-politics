<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hast Rekha</title>
    <link rel="icon" href="./images/logo.svg" type="image/x-icon">
    <!-- link to css -->
    <link rel="stylesheet" href="style.css">
    <!-- link to bootstrap -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <!-- link to jquery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- link to bootstrap -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- link to popper -->
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <!-- Meta Pixel Code -->
<script>
    !function(f,b,e,v,n,t,s)
    {if(f.fbq)return;n=f.fbq=function(){n.callMethod?
    n.callMethod.apply(n,arguments):n.queue.push(arguments)};
    if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
    n.queue=[];t=b.createElement(e);t.async=!0;
    t.src=v;s=b.getElementsByTagName(e)[0];
    s.parentNode.insertBefore(t,s)}(window, document,'script',
    'https://connect.facebook.net/en_US/fbevents.js');
    fbq('init', '859889666534410');
    fbq('track', 'PageView');
    </script>
    <noscript><img height="1" width="1" style="display:none"
    src="https://www.facebook.com/tr?id=859889666534410&ev=PageView&noscript=1"
    /></noscript>
    <!-- End Meta Pixel Code -->
</head>
<body>
    <div class="wrapper-listing">
    <div class="container-fluid ">
        <div class="d-flex justify-content-between align-items-center pt-3 mb-4">
            <h1 class="text-white">Palm Readings List</h1>
        </div>
        
        <div class="table-responsive">
            <table class="table table-striped table-hover">
                <thead class="table-dark">
                    <tr>
                        <th>#</th>
                        <th>Name</th>
                        <th>Phone</th>
                        <th>Order ID</th>
                        <th>Payment ID</th>
                        <th>Created At</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody id="palmTableBody">
                    <tr>
                        <td colspan="5" class="text-center">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
    </div>

    <!-- Modal for viewing palm image -->
    <div class="modal fade" id="palmImageModal" tabindex="-1" aria-labelledby="palmImageModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="palmImageModalLabel">Palm Image</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body text-center">
                    <img id="modalPalmImage" src="" alt="Palm Image" class="img-fluid" style="max-height: 70vh;">
                  
                </div>
            </div>
        </div>
    </div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyD4IQwokYy02_2SQxah0HC9fIHRPxoxoEg",
            authDomain: "palm-reader-7f6b4.firebaseapp.com",
            projectId: "palm-reader-7f6b4",
            storageBucket: "palm-reader-7f6b4.firebasestorage.app",
            messagingSenderId: "277530875490",
            appId: "1:277530875490:web:88b810a4ef964434f2a33b"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // Format date
        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            const date = new Date(dateString);
            return date.toLocaleString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // Get palm image URL (handle both object and string formats)
        function getPalmImageUrl(palmImage) {
            if (!palmImage) return '';
            if (typeof palmImage === 'string') {
                return palmImage;
            }
            if (typeof palmImage === 'object' && palmImage.url) {
                return palmImage.url;
            }
            return '';
        }

        // Load palm readings from Firebase
        async function loadPalmReadings() {
            try {
                const tableBody = document.getElementById('palmTableBody');
                tableBody.innerHTML = '<tr><td colspan="5" class="text-center"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div></td></tr>';

                const snapshot = await db.collection('palmReadings')
                    .orderBy('createdAt', 'desc')
                    .get();

                if (snapshot.empty) {
                    tableBody.innerHTML = '<tr><td colspan="5" class="text-center">No palm readings found.</td></tr>';
                    return;
                }

                tableBody.innerHTML = '';
                let index = 1;

                snapshot.forEach((doc) => {
                    const data = doc.data();
                    const row = document.createElement('tr');
                    
                    const imageUrl = getPalmImageUrl(data.palmImage);
                    const createdAt = formatDate(data.createdAt);

                    row.innerHTML = `
                        <td>${index}</td>
                        <td>${data.name || 'N/A'}</td>
                        <td>${data.phone || 'N/A'}</td>
                        <td>${data.order || '-'}</td>
                        <td>${data.payment_id || '-'}</td>
                        <td>${createdAt}</td>
                        <td>
                            <button class="btn btn-sm btn-info view-palm-btn" 
                                    data-image-url="${imageUrl}"
                                    data-name="${data.name || ''}"
                                    data-phone="${data.phone || ''}"
                                    data-created-at="${createdAt}">
                                View Palm
                            </button>
                        </td>
                    `;
                    
                    tableBody.appendChild(row);
                    index++;
                });

                // Add event listeners to view buttons
                document.querySelectorAll('.view-palm-btn').forEach(button => {
                    button.addEventListener('click', function() {
                        const imageUrl = this.getAttribute('data-image-url');
                        /* const name = this.getAttribute('data-name'); */
                        /* const phone = this.getAttribute('data-phone'); */
                        /* const createdAt = this.getAttribute('data-created-at'); */

                        // Set modal content
                        document.getElementById('modalPalmImage').src = imageUrl;
                    /*     document.getElementById('modalName').textContent = name || 'N/A';
                        document.getElementById('modalPhone').textContent = phone || 'N/A';
                        document.getElementById('modalCreatedAt').textContent = createdAt || 'N/A'; */

                        // Show modal
                        const modal = new bootstrap.Modal(document.getElementById('palmImageModal'));
                        modal.show();
                    });
                });

            } catch (error) {
                console.error('Error loading palm readings:', error);
                document.getElementById('palmTableBody').innerHTML = 
                    '<tr><td colspan="5" class="text-center text-danger">Error loading data. Please try again.</td></tr>';
            }
        }

        // Load data when page loads
        document.addEventListener('DOMContentLoaded', function() {
            loadPalmReadings();
        });
    </script>
</body>
</html>
