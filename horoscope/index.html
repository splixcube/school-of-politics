<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Horoscope Form</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
   <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <!-- Axios -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.10.0/axios.min.js"></script>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCImREVr-D4ZUr3kPk0rVqztnfcgFge0P8",
            authDomain: "horoscope-81d33.firebaseapp.com",
            projectId: "horoscope-81d33",
            storageBucket: "horoscope-81d33.firebasestorage.app",
            messagingSenderId: "714864410936",
            appId: "1:714864410936:web:57b90523d5d350b7c4c1cd"
        };
        
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        
        window.firestoreDb = db;
    </script>
</head>
<body>
    <div class="cosmic-background"></div>
    <div class="container" style="z-index: 9;
    position: relative;">
        <div class="row justify-content-center">

          <!-- Landing Page --> 
             <div class="landing-page p-0" id="landingPage" style="display: block;">
                <div class="banner-content">
                    <img src="assets/images/banner.png" alt="Banner" class="banner-img">
                </div>
                <div class="landing-page-content p-2">
                   

                    
                    <div class="landing-text-block mt-3">
                        <p class="landing-description">Get your personalized palm and astrology reading
                        in just 1 minute. Discover insights about your love
                        life, career, and future.</p>
                    </div>
                    <p class="landing-instruction">Select your gender to begin</p>
                    
                    <div class="gender-selection">
                        <button type="button" class="gender-btn" onclick="selectGender('male')">
                            <div class="gender-icon">♂</div>
                            <span class="gender-label">Male</span>
                        </button>
                        <button type="button" class="gender-btn" onclick="selectGender('female')">
                            <div class="gender-icon">♀</div>
                            <span class="gender-label">Female</span>
                        </button>
                        <button type="button" class="gender-btn" onclick="selectGender('other')">
                            <div class="gender-icon">⚥</div>
                            <span class="gender-label">Other</span>
                        </button>
                    </div>
                </div>
             </div>


            <div class="col-lg-8 col-md-10" id="formSection" style="display: none;">
                <!-- Header Row: Back Button, Logo, Step Count -->
                <div class="header-row mb-3 d-flex align-items-center justify-content-between">
                    <div class="header-item justify-content-start" >
                        <button type="button" class="btn btn-back-header p-0" id="backButton" 
                        style="display: none;">
                            <i class="bi bi-arrow-left"></i>
                        </button>
                    </div>
                    <div class="header-item flex-grow-1 text-center">
                        <img src="assets/images/logo.webp" alt="Logo" class="header-logo">
                    </div>
                    <div class="header-item">
                        <span class="step-count" id="stepCount">Step 1 of 5</span>
                    </div>
                </div>
                
                <!-- Progress Bar -->
                <div class="progress-container mb-4">
                    <div class="progress" style="height: 8px; background-color: var(--secondary);">
                        <div class="progress-bar" role="progressbar" style="width: 20%; background-color: var(--tertiary);" id="progressBar"></div>
                    </div>
                </div>

                <!-- Form Container -->
                <div class="form-container">

                    <!-- Step 1: Name -->
                    <div class="step-content" id="step1">
                        <div class="form-header text-center mb-4">
                            <h2 class="step-title">Enter Your Name</h2>
                            <p class="step-subtitle">Please provide your full name</p>
                        </div>
                        <form id="horoscopeForm">
                            <div class="form-group mb-4">
                                <label for="name" class="form-label">Full Name</label>
                                <input type="text" class="form-control form-input" id="name" name="name" placeholder="Enter your full name" required>
                            </div>
                        </form>
                    </div>

                    <!-- Step 2: WhatsApp Number -->
                    <div class="step-content" id="step2" style="display: none;">
                        <div class="form-header text-center mb-4">
                            <h2 class="step-title">WhatsApp Number</h2>
                            <p class="step-subtitle">Enter your WhatsApp contact number</p>
                        </div>
                        <form>
                            <div class="form-group mb-4">
                                <label for="whatsapp" class="form-label">WhatsApp Number</label>
                                <input type="tel" class="form-control form-input" id="whatsapp" name="whatsapp" placeholder="Enter your 10-digit WhatsApp number" pattern="[0-9]{10}" maxlength="10" required oninput="this.value = this.value.replace(/\D/g, '').slice(0, 10);">
                                <div class="invalid-feedback" id="whatsappError" style="display: none;">
                                    Please enter a valid 10-digit WhatsApp number
                                </div>
                                <div class="invalid-feedback" id="whatsappError" style="display: none;">
                                    Please enter a valid 10-digit WhatsApp number
                                </div>
                            </div>
                        </form>
                    </div>

                    <!-- Step 3: Place of Birth -->
                    <div class="step-content" id="step3" style="display: none;">
                        <div class="form-header text-center mb-4">
                            <h2 class="step-title">Place of Birth</h2>
                            <p class="step-subtitle">Where were you born?</p>
                        </div>
                        <form>
                            <div class="form-group mb-4">
                                <label for="placeOfBirth" class="form-label">Place of Birth</label>
                                <input type="text" class="form-control form-input" id="placeOfBirth" name="placeOfBirth" placeholder="City, State" required>
                            </div>
                        </form>
                    </div>

                    <!-- Step 4: Date of Birth -->
                    <div class="step-content" id="step4" style="display: none;">
                        <div class="form-header text-center mb-4">
                            <h2 class="step-title">Date of Birth</h2>
                            <p class="step-subtitle">When were you born?</p>
                        </div>
                        <form>
                            <div class="form-group mb-4">
                                <label for="dateOfBirth" class="form-label">Date of Birth</label>
                                <input type="date" class="form-control form-input" id="dateOfBirth" name="dateOfBirth" required>
                            </div>
                        </form>
                    </div>

                    <!-- Step 5: Time of Birth -->
                    <div class="step-content" id="step5" style="display: none;">
                        <div class="form-header text-center mb-4">
                            <h2 class="step-title">Time of Birth</h2>
                            <p class="step-subtitle">What time were you born?</p>
                        </div>
                        <form>
                            <div class="form-group mb-4">
                                <label for="timeOfBirth" class="form-label">Time of Birth</label>
                                <input type="time" class="form-control form-input" id="timeOfBirth" name="timeOfBirth" required>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Fixed Bottom Button Container -->
    <div class="fixed-bottom-button" id="fixedBottomButton" style="display: none;">
        <div class="container">
            <div class="row justify-content-center">
                <div class="col-lg-8 col-md-10">
                    <div class="form-actions-bottom">
                        <button type="button" class="btn btn-next" id="nextButton" onclick="nextStep()">Next <i class="bi bi-arrow-right"></i></button>
                        <button type="submit" class="btn btn-submit" id="submitButton" onclick="submitForm(event)" style="display: none;">Submit <i class="bi bi-check-circle"></i></button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentStep = 1;
        const totalSteps = 5;

        function updateProgress() {
            const progress = (currentStep / totalSteps) * 100;
            document.getElementById('progressBar').style.width = progress + '%';
            
            // Update step indicators
          //  document.querySelectorAll('.step-indicator').forEach((indicator, index) => {
          //      if (index + 1 < currentStep) {
          //          indicator.classList.add('completed');
          ////          indicator.classList.remove('active');
          //      } else if (index + 1 === currentStep) {
          //          indicator.classList.add('active');
          //          indicator.classList.remove('completed');
          //      } else {
           //         indicator.classList.remove('active', 'completed');
          //      }
          //  });
        }

        function showStep(step) {
            // Hide all steps
            for (let i = 1; i <= totalSteps; i++) {
                document.getElementById('step' + i).style.display = 'none';
            }
            
            // Show current step
            document.getElementById('step' + step).style.display = 'block';
            
            // Show/hide back button
            if (step >= 1) {
                document.getElementById('backButton').style.display = 'block';
            } 
            
            // Update step count
            document.getElementById('stepCount').textContent = `Step ${step} of ${totalSteps}`;
            
            // Show/hide next and submit buttons
            if (step === totalSteps) {
                document.getElementById('nextButton').style.display = 'none';
                document.getElementById('submitButton').style.display = 'block';
            } else {
                document.getElementById('nextButton').style.display = 'block';
                document.getElementById('submitButton').style.display = 'none';
            }
            
            updateProgress();
        }

        function nextStep() {
            // Validate current step
            const currentStepElement = document.getElementById('step' + currentStep);
            const input = currentStepElement.querySelector('input[required]');
            
            if (input && !input.value.trim()) {
                input.classList.add('is-invalid');
                return;
            }
            
            // Special validation for WhatsApp number (step 2) - must be exactly 10 digits
            if (currentStep === 2) {
                const whatsappInput = document.getElementById('whatsapp');
                const whatsappValue = whatsappInput.value.trim().replace(/\D/g, ''); // Remove non-digits
                
                if (whatsappValue.length !== 10) {
                    whatsappInput.classList.add('is-invalid');
                    const errorDiv = document.getElementById('whatsappError');
                    if (errorDiv) {
                        errorDiv.style.display = 'block';
                    }
                    return;
                } else {
                    whatsappInput.classList.remove('is-invalid');
                    const errorDiv = document.getElementById('whatsappError');
                    if (errorDiv) {
                        errorDiv.style.display = 'none';
                    }
                    // Update the input value to only digits
                    whatsappInput.value = whatsappValue;
                }
            }
            
            if (currentStep < totalSteps) {
                currentStep++;
                showStep(currentStep);
            }
        }

        function previousStep() {
            if (currentStep > 1) {
                currentStep--;
                showStep(currentStep);
            } else if (currentStep === 1) {
                // If on step 1, go back to landing page
                document.getElementById('landingPage').style.display = 'block';
                document.getElementById('formSection').style.display = 'none';
                document.getElementById('fixedBottomButton').style.display = 'none';
                // Reset step count
                document.getElementById('stepCount').textContent = 'Step 1 of 5';
                // Hide back button
                document.getElementById('backButton').style.display = 'none';
            }
        }

        // Store form data globally to use after payment
        let formDataToStore = {};
        let selectedGender = '';

        function selectGender(gender) {
            selectedGender = gender;
            console.log('Gender selected:', gender);
            // Hide landing page
            document.getElementById('landingPage').style.display = 'none';
            // Show form section
            document.getElementById('formSection').style.display = 'block';
            // Show fixed bottom button
            document.getElementById('fixedBottomButton').style.display = 'block';
            // Start with step 1
            currentStep = 1;
            showStep(1);
        }

        async function submitForm(event) {
            event.preventDefault();
            
            // Validate last step
            const timeInput = document.getElementById('timeOfBirth');
            if (!timeInput.value) {
                timeInput.classList.add('is-invalid');
                return;
            }
            
            // Collect all form data
            formDataToStore = {
                gender: selectedGender || '',
                name: document.getElementById('name').value,
                whatsapp: document.getElementById('whatsapp').value,
                placeOfBirth: document.getElementById('placeOfBirth').value,
                dateOfBirth: document.getElementById('dateOfBirth').value,
                timeOfBirth: document.getElementById('timeOfBirth').value,
                payment_status: 'pending',
                created_at: new Date().toISOString()
            };
            
            // Console log the data
            console.log('Form Data Submitted:', formDataToStore);
            
            // Show loading spinner
            Swal.fire({
                title: 'Saving your information...',
                html: 'Please wait while we save your data.',
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });
            
            // First, save data to Firebase
            try {
                if (window.firestoreDb) {
                    const docRef = await window.firestoreDb.collection('horoscope_submissions').add(formDataToStore);
                    const documentId = docRef.id;
                    
                    console.log('Data saved to Firebase with ID:', documentId);
                    
                    // Close loading and proceed with payment
                    Swal.close();
                    
                    // Prepare payment booking with document ID
                    initiatePayment(documentId);
                } else {
                    // Retry after a short delay if Firebase not ready
                    setTimeout(() => submitForm(event), 1000);
                }
            } catch (error) {
                console.error('Error saving to Firebase:', error);
                Swal.close();
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'Failed to save your information. Please try again.',
                    confirmButtonColor: '#5F9598',
                    confirmButtonText: 'OK'
                });
            }
        }

        function initiatePayment(documentId) {
            // Set package type
            const packageType = 'Hast Rekha'; //horoscope
            
            // Set success redirect URL to successpage.html with document ID
            const baseUrl = window.location.origin;
            const currentPath = window.location.pathname;
            const directoryPath = currentPath.substring(0, currentPath.lastIndexOf('/'));
            const successRedirectUrl = baseUrl + (directoryPath ? directoryPath : '') + '/successpage.html?doc_id=' + encodeURIComponent(documentId);
            
            // Show loading spinner
            Swal.fire({
                title: 'Processing your booking...',
                html: 'Please wait while we process your request.',
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });

            // Prepare form data for payment API
            const paymentFormData = new URLSearchParams();
            paymentFormData.append('package-type', packageType);
            paymentFormData.append('success_redirect_url', successRedirectUrl);
            
            console.log("Payment form data:", paymentFormData.toString());
            console.log("Success redirect URL:", successRedirectUrl);

            // Submit to payment API
            axios.post('https://sanatanis.app/mainajaxcalls/main/book', paymentFormData.toString(), {
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded'
                }
            })
                .then(function (response) {
                    if (response.data.success_msg) {
                        const responseData = response.data.data;

                        if (responseData && responseData.redirect_url) {
                            // Redirect to the payment page
                            // Document ID is already stored in sessionStorage from submitForm
                            window.location.href = responseData.redirect_url;
                        } else {
                            Swal.close();
                            Swal.fire({
                                icon: 'error',
                                title: 'Booking Failed',
                                text: response.data.errors[0] || 'Something went wrong. Please try again later.',
                                confirmButtonColor: '#5F9598',
                                confirmButtonText: 'OK'
                            });
                        }
                    } else {
                        Swal.close();
                        Swal.fire({
                            icon: 'error',
                            title: 'Booking Failed',
                            text: response.data.message || 'Something went wrong. Please try again later.',
                            confirmButtonColor: '#5F9598',
                            confirmButtonText: 'OK'
                        });
                    }
                })
                .catch(function (error) {
                    console.error('Error:', error);
                    Swal.close();
                    Swal.fire({
                        icon: 'error',
                        title: 'Booking Failed',
                        text: 'An error occurred while processing your request. Please try again later.',
                        confirmButtonColor: '#5F9598',
                        confirmButtonText: 'OK'
                    });
                });
        }

        // Handle payment success callback
        async function handlePaymentSuccess() {
            // Get URL parameters
            const urlParams = new URLSearchParams(window.location.search);
            const paymentSuccess = urlParams.get('payment_success');
            const paymentId = urlParams.get('payment_id') || 
                             urlParams.get('razorpay_payment_id') || 
                             urlParams.get('transaction_id') ||
                             urlParams.get('paymentId') ||
                             urlParams.get('txnid');
            const orderId = urlParams.get('order') || 
                           urlParams.get('order_id') || 
                           urlParams.get('razorpay_order_id') || 
                           urlParams.get('orderId') ||
                           urlParams.get('orderid');
            
            // Check if payment was successful (either by parameter or by having payment/order IDs)
            if (paymentSuccess === 'true' || paymentId || orderId) {
                // Get stored Firebase document ID
                const documentId = sessionStorage.getItem('firebaseDocId');
                
                if (!documentId) {
                    console.error('Firebase document ID not found in sessionStorage');
                    Swal.fire({
                        icon: 'warning',
                        title: 'Payment Successful',
                        text: 'Payment confirmed but document ID not found. Please contact support.',
                        confirmButtonColor: '#5F9598',
                        confirmButtonText: 'OK'
                    });
                    return;
                }
                
                // Prepare payment update data
                const paymentUpdateData = {
                    payment_id: paymentId || '',
                    order: orderId || '',
                    payment_date: new Date().toISOString(),
                    payment_status: (paymentId || orderId) ? 'success' : 'pending',
                    updated_at: new Date().toISOString()
                };
                
                console.log('Updating Firebase document:', documentId, 'with payment data:', paymentUpdateData);
                
                // Update Firebase document with payment information
                try {
                    // Wait for Firebase to be ready
                    if (window.firestoreDb) {
                        await window.firestoreDb.collection('horoscope_submissions').doc(documentId).update(paymentUpdateData);
                        
                        console.log('Payment data updated in Firebase successfully');
                        
                        // Redirect to success page
                        window.location.href = 'successpage.html';
                    } else {
                        // Retry after a short delay if Firebase not ready
                        setTimeout(handlePaymentSuccess, 1000);
                    }
                } catch (error) {
                    console.error('Error updating Firebase document:', error);
                    Swal.fire({
                        icon: 'warning',
                        title: 'Payment Successful',
                        text: 'Payment confirmed but there was an issue updating the record. Please contact support.',
                        confirmButtonColor: '#5F9598',
                        confirmButtonText: 'OK'
                    });
                }
            }
        }

        // Check for payment success on page load (only if redirected back to this page)
        window.addEventListener('DOMContentLoaded', function() {
            const urlParams = new URLSearchParams(window.location.search);
            const paymentSuccess = urlParams.get('payment_success');
            // Only handle payment success if we're on this page (fallback scenario)
            if (paymentSuccess === 'true') {
                setTimeout(handlePaymentSuccess, 500);
            }
        });

        // Initialize
        document.getElementById('backButton').addEventListener('click', previousStep);
        // Landing page is shown by default, form section and button are hidden until gender is selected
    </script>
</body>
</html>