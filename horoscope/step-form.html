<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Horoscope Form</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
   <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <!-- Axios -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.10.0/axios.min.js"></script>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCImREVr-D4ZUr3kPk0rVqztnfcgFge0P8",
            authDomain: "horoscope-81d33.firebaseapp.com",
            projectId: "horoscope-81d33",
            storageBucket: "horoscope-81d33.firebasestorage.app",
            messagingSenderId: "714864410936",
            appId: "1:714864410936:web:57b90523d5d350b7c4c1cd"
        };
        
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        
        window.firestoreDb = db;
    </script>
    <!-- Meta Pixel Code -->
<script>
    !function(f,b,e,v,n,t,s)
    {if(f.fbq)return;n=f.fbq=function(){n.callMethod?
    n.callMethod.apply(n,arguments):n.queue.push(arguments)};
    if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
    n.queue=[];t=b.createElement(e);t.async=!0;
    t.src=v;s=b.getElementsByTagName(e)[0];
    s.parentNode.insertBefore(t,s)}(window, document,'script',
    'https://connect.facebook.net/en_US/fbevents.js');
    fbq('init', '806488919150102');
    fbq('track', 'PageView');
    </script>
    <noscript><img height="1" width="1" style="display:none"
    src="https://www.facebook.com/tr?id=806488919150102&ev=PageView&noscript=1"
    /></noscript>
    <!-- End Meta Pixel Code -->
</head>
<body>
    <div class="cosmic-background">
        <div class="cosmic-background-overlay"></div>
    </div>
    <div class="container" style="z-index: 9;
    position: relative;">
        <div class="row justify-content-center">


            <div class="col-lg-8 col-md-10" id="formSection">
                <!-- Header Row: Back Button, Logo, Step Count -->
                <div class="header-row mb-3 d-flex align-items-center justify-content-start">
                     <button type="button" class="btn btn-back-header p-0" id="backButton" 
                        style="display: none;">
                            <i class="bi bi-arrow-left"></i>
                        </button>
                        <h6 class="fs-16 m-0 fw-600 ms-2" >Horoscope</h6>
                 
                </div>
                
                <!-- Progress Bar -->
                 <div class="d-flex mb-4 align-items-center">
                    <span class="step-count" id="stepCount">1/5</span>
                    <div class="progress-container w-100 ms-2">
                        <div class="progress" style="height: 3px; background-color: var(--secondary);">
                            <div class="progress-bar" role="progressbar" style="width: 20%; background-color: #F8B239; transition: width 0.3s ease;" id="progressBar"></div>
                        </div>
                    </div>
                 </div>
              

                <!-- Form Container -->
                <div class="form-container">

                    <!-- Step 1: Name -->
                    <div class="step-content" id="step1">
                        <div class="form-header text-center mb-4">
                            <h2 class="step-title">Your full name</h2>
                        </div>
                        <form id="horoscopeForm">
                            <div class="form-group mb-4">
                                <input type="text" class="form-control form-input" id="name" name="name" placeholder="Enter your full name" required>
                                <div class="error-message" id="nameError" style="display: none;">Please enter your full name</div>
                            </div>
                         </form>
                    </div>  

                    <!-- Step 2: Gender Selection -->
                    <div class="step-content" id="step2" style="display: none;">
                        <div class="form-header text-center mb-4">
                            <h2 class="step-title">Your gender</h2>
                        </div>
                        <div class="gender-selection">
                            <button type="button" class="gender-btn" id="gender-male" onclick="selectGenderStep2('male')">
                                <div class="gender-icon">♂</div>
                                <span class="gender-label">Male</span>
                            </button>
                            <button type="button" class="gender-btn" id="gender-female" onclick="selectGenderStep2('female')">
                                <div class="gender-icon">♀</div>
                                <span class="gender-label">Female</span>
                            </button>
                            <button type="button" class="gender-btn" id="gender-other" onclick="selectGenderStep2('other')">
                                <div class="gender-icon">⚥</div>
                                <span class="gender-label">Other</span>
                            </button>
                        </div>
                        <div class="error-message text-center mt-3" id="genderError" style="display: none;">Please select your gender</div>
                    </div>

                    <!-- Step 3: Place of Birth -->
                    <div class="step-content" id="step3" style="display: none;">
                        <div class="form-header text-center mb-4">
                            <h2 class="step-title">Your place of birth</h2>
                        </div>
                        <form>
                            <div class="form-group mb-4">
                                <select class="form-control form-input" id="stateOfBirth" name="stateOfBirth" required>
                                    <option value="">Select State</option>
                                    <option value="Andhra Pradesh">Andhra Pradesh</option>
                                    <option value="Arunachal Pradesh">Arunachal Pradesh</option>
                                    <option value="Assam">Assam</option>
                                    <option value="Bihar">Bihar</option>
                                    <option value="Chhattisgarh">Chhattisgarh</option>
                                    <option value="Goa">Goa</option>
                                    <option value="Gujarat">Gujarat</option>
                                    <option value="Haryana">Haryana</option>
                                    <option value="Himachal Pradesh">Himachal Pradesh</option>
                                    <option value="Jharkhand">Jharkhand</option>
                                    <option value="Karnataka">Karnataka</option>
                                    <option value="Kerala">Kerala</option>
                                    <option value="Madhya Pradesh">Madhya Pradesh</option>
                                    <option value="Maharashtra">Maharashtra</option>
                                    <option value="Manipur">Manipur</option>
                                    <option value="Meghalaya">Meghalaya</option>
                                    <option value="Mizoram">Mizoram</option>
                                    <option value="Nagaland">Nagaland</option>
                                    <option value="Odisha">Odisha</option>
                                    <option value="Punjab">Punjab</option>
                                    <option value="Rajasthan">Rajasthan</option>
                                    <option value="Sikkim">Sikkim</option>
                                    <option value="Tamil Nadu">Tamil Nadu</option>
                                    <option value="Telangana">Telangana</option>
                                    <option value="Tripura">Tripura</option>
                                    <option value="Uttar Pradesh">Uttar Pradesh</option>
                                    <option value="Uttarakhand">Uttarakhand</option>
                                    <option value="West Bengal">West Bengal</option>
                                    <option value="Andaman and Nicobar Islands">Andaman and Nicobar Islands</option>
                                    <option value="Chandigarh">Chandigarh</option>
                                    <option value="Dadra and Nagar Haveli and Daman and Diu">Dadra and Nagar Haveli and Daman and Diu</option>
                                    <option value="Delhi">Delhi</option>
                                    <option value="Jammu and Kashmir">Jammu and Kashmir</option>
                                    <option value="Ladakh">Ladakh</option>
                                    <option value="Lakshadweep">Lakshadweep</option>
                                    <option value="Puducherry">Puducherry</option>
                                </select>
                                <div class="error-message" id="stateOfBirthError" style="display: none;">Please select a state</div>
                            </div>
                            <div class="form-group mb-4">
                                <input type="text" class="form-control form-input" id="cityOfBirth" name="cityOfBirth" placeholder="Enter City" required>
                                <div class="error-message" id="cityOfBirthError" style="display: none;">Please enter your city</div>
                            </div>
                        </form>
                    </div>

                    <!-- Step 4: Date of Birth -->
                    <div class="step-content" id="step4" style="display: none;">
                        <div class="form-header text-center mb-4">
                            <h2 class="step-title">Your Date of Birth</h2>
                        </div>
                        <form>
                            <div class="form-group mb-4">
                                <div class="calendar-icon-container">
                                <input class="w-100 form-control form-input"
                                type="text"
                                placeholder="dd/mm/yyyy"
                                id="dateOfBirth" name="dateOfBirth" required readonly>
                                <img src="assets/images/calendar.png" alt="Calendar" class="calendar-icon">
                            </div>
                            <div class="error-message" id="dateOfBirthError" style="display: none;">Please select your date of birth</div>
                                <input class="w-100 form-control form-input date-input-hidden"
                                type="date" style="visibility: hidden;"
                                id="dateOfBirthInput" name="dateOfBirthInput" required>
                             
                            </div>
                        </form>
                    </div>

                    <!-- Step 5: Time of Birth -->
                    <div class="step-content" id="step5" style="display: none;">
                        <div class="form-header text-center mb-4">
                            <h2 class="step-title">Time of birth</h2>
                        </div>
                        <form>
                            <div class="form-group mb-4">
                                <div class="calendar-icon-container">
                                <input class="w-100 form-control form-input"
                                type="text"
                                placeholder="HH:MM"
                                id="timeOfBirth" name="timeOfBirth" required readonly>
                                <img src="assets/images/calendar.png" alt="Calendar" class="calendar-icon">
                                </div>
                                <div class="error-message" id="timeOfBirthError" style="display: none;">Please select your time of birth</div>
                                <input class="w-100 form-control form-input time-input-hidden"
                                type="time" style="visibility: hidden;"
                                id="timeOfBirthInput" name="timeOfBirthInput" required>
                               
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Fixed Bottom Button Container -->
    <div class="fixed-bottom-button" id="fixedBottomButton">
       
        <div class="container">
            <div class="row justify-content-center">
                <div class="col-lg-8 col-md-10">
                    <div class="form-actions-bottom">
                        <button type="button" class="btn primary-custom" id="nextButton" onclick="nextStep()">Next 
                            <img src="assets/images/arrow-r.svg" alt="Banner" class="img-fluid ms-2">
                        </button>
                        <button type="submit" class="btn primary-custom" id="submitButton" onclick="submitForm(event)" style="display: none;">Submit <i class="bi bi-check-circle"></i></button>
                    </div>
                </div>
            </div>
        </div>
        <p class="fs-12 mb-0 text-center text-tertiary onest-font mt-2">
            Secure. Takes less than a minute
        </p>
    </div>

    <script>
        let currentStep = 1;
        const totalSteps = 5;

        function updateProgress() {
            // Calculate progress percentage based on current step
            // Step 1 = 20%, Step 2 = 40%, Step 3 = 60%, Step 4 = 80%, Step 5 = 100%
            const progress = (currentStep / totalSteps) * 100;
            const progressBar = document.getElementById('progressBar');
            if (progressBar) {
                progressBar.style.width = progress + '%';
                // Update aria attributes for accessibility
                progressBar.setAttribute('aria-valuenow', currentStep);
                progressBar.setAttribute('aria-valuemin', 1);
                progressBar.setAttribute('aria-valuemax', totalSteps);
            }
        }

        function showStep(step) {
            // Hide all steps
            for (let i = 1; i <= totalSteps; i++) {
                document.getElementById('step' + i).style.display = 'none';
            }
            
            // Show current step
            document.getElementById('step' + step).style.display = 'block';
            
            // Show/hide back button
            if (step >= 1) {
                document.getElementById('backButton').style.display = 'block';
            } 
            
            // Update step count
            document.getElementById('stepCount').textContent = `${step}/${totalSteps}`;
            
            // Show/hide next and submit buttons
            if (step === totalSteps) {
                document.getElementById('nextButton').style.display = 'none';
                document.getElementById('submitButton').style.display = 'block';
            } else {
                document.getElementById('nextButton').style.display = 'block';
                document.getElementById('submitButton').style.display = 'none';
            }
            
            // If showing step 2, highlight previously selected gender if any
            if (step === 2) {
                highlightSelectedGender();
            }
            
            updateProgress();
        }

        function clearErrors() {
            // Clear all error messages and invalid classes
            document.querySelectorAll('.error-message').forEach(error => {
                error.style.display = 'none';
            });
            document.querySelectorAll('.is-invalid').forEach(input => {
                input.classList.remove('is-invalid');
            });
        }

        function clearFieldError(fieldId, errorId) {
            const field = document.getElementById(fieldId);
            const error = document.getElementById(errorId);
            if (field) {
                field.classList.remove('is-invalid');
            }
            if (error) {
                error.style.display = 'none';
            }
        }

        function showError(errorId, message) {
            const errorElement = document.getElementById(errorId);
            if (errorElement) {
                errorElement.textContent = message;
                errorElement.style.display = 'block';
            }
        }

        function validateStep(step) {
            clearErrors();
            let isValid = true;

            if (step === 1) {
                // Validate Name
                const nameInput = document.getElementById('name');
                if (!nameInput.value.trim()) {
                    nameInput.classList.add('is-invalid');
                    showError('nameError', 'Please enter your full name');
                    isValid = false;
                }
            } else if (step === 2) {
                // Validate Gender
                if (!selectedGender) {
                    showError('genderError', 'Please select your gender');
                    isValid = false;
                }
            } else if (step === 3) {
                // Validate Place of Birth (State and City)
                const stateSelect = document.getElementById('stateOfBirth');
                const cityInput = document.getElementById('cityOfBirth');
                
                if (!stateSelect.value) {
                    stateSelect.classList.add('is-invalid');
                    showError('stateOfBirthError', 'Please select a state');
                    isValid = false;
                }
                
                if (!cityInput.value.trim()) {
                    cityInput.classList.add('is-invalid');
                    showError('cityOfBirthError', 'Please enter your city');
                    isValid = false;
                }
            } else if (step === 4) {
                // Validate Date of Birth
                const dateInput = document.getElementById('dateOfBirthInput');
                const dateTextInput = document.getElementById('dateOfBirth');
                if (!dateInput.value) {
                    dateInput.classList.add('is-invalid');
                    if (dateTextInput) {
                        dateTextInput.classList.add('is-invalid');
                    }
                    showError('dateOfBirthError', 'Please select your date of birth');
                    isValid = false;
                }
            } else if (step === 5) {
                // Validate Time of Birth
                const timeInput = document.getElementById('timeOfBirthInput');
                const timeTextInput = document.getElementById('timeOfBirth');
                if (!timeInput.value) {
                    timeInput.classList.add('is-invalid');
                    if (timeTextInput) {
                        timeTextInput.classList.add('is-invalid');
                    }
                    showError('timeOfBirthError', 'Please select your time of birth');
                    isValid = false;
                }
            }

            return isValid;
        }

        function nextStep() {
            // Validate current step
            if (!validateStep(currentStep)) {
                return;
            }
            
            if (currentStep < totalSteps) {
                currentStep++;
                showStep(currentStep);
            }
        }

        function previousStep() {
            if (currentStep > 1) {
                currentStep--;
                showStep(currentStep);
            } else if (currentStep === 1) {
                // If on step 1, go back to index page
                window.location.href = 'index.html';
            }
        }

        // Store form data globally to use after payment
        let formDataToStore = {};
        let selectedGender = '';

        function selectGender(gender) {
            selectedGender = gender;
            console.log('Gender selected:', gender);
            // Hide landing page
            document.getElementById('landingPage').style.display = 'none';
            // Show form section
            document.getElementById('formSection').style.display = 'block';
            // Show fixed bottom button
            document.getElementById('fixedBottomButton').style.display = 'block';
            // Start with step 1
            currentStep = 1;
            showStep(1);
        }

        function selectGenderStep2(gender) {
            selectedGender = gender;
            console.log('Gender selected in step 2:', gender);
            highlightSelectedGender();
            // Clear gender error when gender is selected
            clearFieldError('genderError', 'genderError');
        }

        function highlightSelectedGender() {
            // Remove active class from all gender buttons
            document.querySelectorAll('.gender-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Add active class to selected gender button
            if (selectedGender) {
                const selectedButton = document.getElementById('gender-' + selectedGender);
                if (selectedButton) {
                    selectedButton.classList.add('active');
                }
            }
        }

        async function submitForm(event) {
            event.preventDefault();
            
            // Validate last step - check if time is filled
            const timeInput = document.getElementById('timeOfBirthInput');
            const timeTextInput = document.getElementById('timeOfBirth');
            if (!timeInput.value) {
                timeInput.classList.add('is-invalid');
                if (timeTextInput) {
                    timeTextInput.classList.add('is-invalid');
                }
                showError('timeOfBirthError', 'Please select your time of birth');
                return;
            }
            
            // Collect all form data
            const stateOfBirth = document.getElementById('stateOfBirth').value;
            const cityOfBirth = document.getElementById('cityOfBirth').value;
            
            formDataToStore = {
                gender: selectedGender || '',
                name: document.getElementById('name').value,
                stateOfBirth: stateOfBirth,
                cityOfBirth: cityOfBirth,
                dateOfBirth: document.getElementById('dateOfBirthInput').value,
                timeOfBirth: document.getElementById('timeOfBirthInput').value,
                payment_status: 'pending',
                created_at: new Date().toISOString()
            };
            
            // Console log the data
            console.log('Form Data Submitted:', formDataToStore);
            
            // Show loading spinner
            Swal.fire({
                title: 'Saving your information...',
                html: 'Please wait while we save your data.',
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });
            
            // First, save data to Firebase
            try {
                if (window.firestoreDb) {
                    console.log('Form data to store:', formDataToStore);
                    const docRef = await window.firestoreDb.collection('horoscope_submissions').add(formDataToStore);
                    const documentId = docRef.id;
                    
                    console.log('Data saved to Firebase with ID:', documentId);
                    
                    // Close loading and proceed with payment
                    Swal.close();
                    
                    // Prepare payment booking with document ID
                    initiatePayment(documentId);
                } else {
                    // Retry after a short delay if Firebase not ready
                    setTimeout(() => submitForm(event), 1000);
                }
            } catch (error) {
                console.error('Error saving to Firebase:', error);
                Swal.close();
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'Failed to save your information. Please try again.',
                    confirmButtonColor: '#5F9598',
                    confirmButtonText: 'OK'
                });
            }
        }

        function initiatePayment(documentId) {
            // Set package type
            const packageType = 'Hast Rekha'; //horoscope
            
            // Set success redirect URL to successpage.html with document ID
            const baseUrl = window.location.origin;
            const currentPath = window.location.pathname;
            const directoryPath = currentPath.substring(0, currentPath.lastIndexOf('/'));
            const successRedirectUrl = baseUrl + (directoryPath ? directoryPath : '') + '/successpage.html?doc_id=' + encodeURIComponent(documentId);
            
            // Show loading spinner
            Swal.fire({
                title: 'Processing your booking...',
                html: 'Please wait while we process your request.',
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });

            // Prepare form data for payment API
            const paymentFormData = new URLSearchParams();
            paymentFormData.append('package-type', packageType);
            paymentFormData.append('success_redirect_url', successRedirectUrl);
            
            console.log("Payment form data:", paymentFormData.toString());
            console.log("Success redirect URL:", successRedirectUrl);

            // Submit to payment API
            axios.post('https://sanatanis.app/mainajaxcalls/main/book', paymentFormData.toString(), {
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded'
                }
            })
                .then(function (response) {
                    if (response.data.success_msg) {
                        const responseData = response.data.data;

                        if (responseData && responseData.redirect_url) {
                            // Redirect to the payment page
                            // Document ID is already stored in sessionStorage from submitForm
                            window.location.href = responseData.redirect_url;
                        } else {
                            Swal.close();
                            Swal.fire({
                                icon: 'error',
                                title: 'Booking Failed',
                                text: response.data.errors[0] || 'Something went wrong. Please try again later.',
                                confirmButtonColor: '#5F9598',
                                confirmButtonText: 'OK'
                            });
                        }
                    } else {
                        Swal.close();
                        Swal.fire({
                            icon: 'error',
                            title: 'Booking Failed',
                            text: response.data.message || 'Something went wrong. Please try again later.',
                            confirmButtonColor: '#5F9598',
                            confirmButtonText: 'OK'
                        });
                    }
                })
                .catch(function (error) {
                    console.error('Error:', error);
                    Swal.close();
                    Swal.fire({
                        icon: 'error',
                        title: 'Booking Failed',
                        text: 'An error occurred while processing your request. Please try again later.',
                        confirmButtonColor: '#5F9598',
                        confirmButtonText: 'OK'
                    });
                });
        }

        // Handle payment success callback
        async function handlePaymentSuccess() {
            // Get URL parameters
            const urlParams = new URLSearchParams(window.location.search);
            const paymentSuccess = urlParams.get('payment_success');
            const paymentId = urlParams.get('payment_id') || 
                             urlParams.get('razorpay_payment_id') || 
                             urlParams.get('transaction_id') ||
                             urlParams.get('paymentId') ||
                             urlParams.get('txnid');
            const orderId = urlParams.get('order') || 
                           urlParams.get('order_id') || 
                           urlParams.get('razorpay_order_id') || 
                           urlParams.get('orderId') ||
                           urlParams.get('orderid');
            
            // Check if payment was successful (either by parameter or by having payment/order IDs)
            if (paymentSuccess === 'true' || paymentId || orderId) {
                // Get stored Firebase document ID
                const documentId = sessionStorage.getItem('firebaseDocId');
                
                if (!documentId) {
                    console.error('Firebase document ID not found in sessionStorage');
                    Swal.fire({
                        icon: 'warning',
                        title: 'Payment Successful',
                        text: 'Payment confirmed but document ID not found. Please contact support.',
                        confirmButtonColor: '#5F9598',
                        confirmButtonText: 'OK'
                    });
                    return;
                }
                
                // Prepare payment update data
                const paymentUpdateData = {
                    payment_id: paymentId || '',
                    order: orderId || '',
                    payment_date: new Date().toISOString(),
                    payment_status: (paymentId || orderId) ? 'success' : 'pending',
                    updated_at: new Date().toISOString()
                };
                
                console.log('Updating Firebase document:', documentId, 'with payment data:', paymentUpdateData);
                
                // Update Firebase document with payment information
                try {
                    // Wait for Firebase to be ready
                    if (window.firestoreDb) {
                        await window.firestoreDb.collection('horoscope_submissions').doc(documentId).update(paymentUpdateData);
                        
                        console.log('Payment data updated in Firebase successfully');
                        
                        // Redirect to success page
                        window.location.href = 'successpage.html';
                    } else {
                        // Retry after a short delay if Firebase not ready
                        setTimeout(handlePaymentSuccess, 1000);
                    }
                } catch (error) {
                    console.error('Error updating Firebase document:', error);
                    Swal.fire({
                        icon: 'warning',
                        title: 'Payment Successful',
                        text: 'Payment confirmed but there was an issue updating the record. Please contact support.',
                        confirmButtonColor: '#5F9598',
                        confirmButtonText: 'OK'
                    });
                }
            }
        }

        // Initialize - Show step 1 on page load
        document.getElementById('backButton').addEventListener('click', previousStep);
        
        // Check for payment success on page load or show step 1 initially
        window.addEventListener('DOMContentLoaded', function() {
            const urlParams = new URLSearchParams(window.location.search);
            const paymentSuccess = urlParams.get('payment_success');
            // Only handle payment success if we're on this page (fallback scenario)
            if (paymentSuccess === 'true') {
                setTimeout(handlePaymentSuccess, 500);
                return;
            }
            
            // Add event listeners to clear errors when users interact with fields
            const nameInput = document.getElementById('name');
            if (nameInput) {
                nameInput.addEventListener('input', function() {
                    clearFieldError('name', 'nameError');
                });
            }
            
            const stateSelect = document.getElementById('stateOfBirth');
            if (stateSelect) {
                stateSelect.addEventListener('change', function() {
                    clearFieldError('stateOfBirth', 'stateOfBirthError');
                });
            }
            
            const cityInput = document.getElementById('cityOfBirth');
            if (cityInput) {
                cityInput.addEventListener('input', function() {
                    clearFieldError('cityOfBirth', 'cityOfBirthError');
                });
            }
            
            const dateTextInput = document.getElementById('dateOfBirth');
            const dateInput = document.getElementById('dateOfBirthInput');
            
            if (dateTextInput && dateInput) {
                // Format date to dd/mm/yyyy
                function formatDate(dateString) {
                    if (!dateString) return '';
                    const date = new Date(dateString + 'T00:00:00');
                    const day = String(date.getDate()).padStart(2, '0');
                    const month = String(date.getMonth() + 1).padStart(2, '0');
                    const year = date.getFullYear();
                    return `${day}/${month}/${year}`;
                }
                
                // Open date picker when text input is clicked
                dateTextInput.addEventListener('click', function(e) {
                    e.preventDefault();
                    if (dateInput.showPicker) {
                        dateInput.showPicker();
                    } else {
                        // Fallback for browsers that don't support showPicker()
                        dateInput.focus();
                        dateInput.click();
                    }
                });
                
                dateTextInput.addEventListener('focus', function(e) {
                    e.preventDefault();
                    if (dateInput.showPicker) {
                        dateInput.showPicker();
                    } else {
                        // Fallback for browsers that don't support showPicker()
                        dateInput.focus();
                        dateInput.click();
                    }
                });
                
                // Update text input when date is selected
                dateInput.addEventListener('change', function() {
                    const formattedDate = formatDate(this.value);
                    dateTextInput.value = formattedDate;
                    clearFieldError('dateOfBirth', 'dateOfBirthError');
                    clearFieldError('dateOfBirthInput', 'dateOfBirthError');
                });
                
                // Also listen for input event (for mobile)
                dateInput.addEventListener('input', function() {
                    const formattedDate = formatDate(this.value);
                    dateTextInput.value = formattedDate;
                });
            }
            
            const timeTextInput = document.getElementById('timeOfBirth');
            const timeInput = document.getElementById('timeOfBirthInput');
            
            if (timeTextInput && timeInput) {
                // Format time to HH:MM (24-hour format)
                function formatTime(timeString) {
                    if (!timeString) return '';
                    // timeString is already in HH:MM format from time input
                    return timeString;
                }
                
                // Open time picker when text input is clicked
                timeTextInput.addEventListener('click', function(e) {
                    e.preventDefault();
                    if (timeInput.showPicker) {
                        timeInput.showPicker();
                    } else {
                        // Fallback for browsers that don't support showPicker()
                        timeInput.focus();
                        timeInput.click();
                    }
                });
                
                timeTextInput.addEventListener('focus', function(e) {
                    e.preventDefault();
                    if (timeInput.showPicker) {
                        timeInput.showPicker();
                    } else {
                        // Fallback for browsers that don't support showPicker()
                        timeInput.focus();
                        timeInput.click();
                    }
                });
                
                // Update text input when time is selected
                timeInput.addEventListener('change', function() {
                    const formattedTime = formatTime(this.value);
                    timeTextInput.value = formattedTime;
                    clearFieldError('timeOfBirth', 'timeOfBirthError');
                    clearFieldError('timeOfBirthInput', 'timeOfBirthError');
                });
                
                // Also listen for input event (for mobile)
                timeInput.addEventListener('input', function() {
                    const formattedTime = formatTime(this.value);
                    timeTextInput.value = formattedTime;
                });
            }
            
            // Otherwise, show step 1 initially
            currentStep = 1;
            showStep(1);
        });
    </script>
</body>
</html>