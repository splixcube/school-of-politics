<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Horoscope Form</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
   <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <!-- Axios -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.10.0/axios.min.js"></script>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCImREVr-D4ZUr3kPk0rVqztnfcgFge0P8",
            authDomain: "horoscope-81d33.firebaseapp.com",
            projectId: "horoscope-81d33",
            storageBucket: "horoscope-81d33.firebasestorage.app",
            messagingSenderId: "714864410936",
            appId: "1:714864410936:web:57b90523d5d350b7c4c1cd"
        };
        
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        
        window.firestoreDb = db;
    </script>
</head>
<body>
    <div class="cosmic-background">
        <div class="cosmic-background-overlay"></div>
    </div>
    <div class="container" style="z-index: 9;
    position: relative;">
        <div class="row justify-content-center">


            <div class="col-lg-8 col-md-10" id="formSection">
                <!-- Header Row: Back Button, Logo, Step Count -->
                <div class="header-row mb-3 d-flex align-items-center justify-content-start">
                     <button type="button" class="btn btn-back-header p-0" id="backButton" 
                        style="display: none;">
                            <i class="bi bi-arrow-left"></i>
                        </button>
                        <h6 class="fs-16 m-0 fw-600 ms-2" >Horoscope</h6>
                 
                </div>
                
                <!-- Progress Bar -->
                 <div class="d-flex mb-4 align-items-center">
                    <span class="step-count" id="stepCount">1/6</span>
                    <div class="progress-container w-100 ms-2">
                        <div class="progress" style="height: 8px; background-color: var(--secondary);">
                            <div class="progress-bar" role="progressbar" style="width: 16.67%; background-color: #F8B239; transition: width 0.3s ease;" id="progressBar"></div>
                        </div>
                    </div>
                 </div>
              

                <!-- Form Container -->
                <div class="form-container">

                    <!-- Step 1: Name -->
                    <div class="step-content" id="step1">
                        <div class="form-header text-center mb-4">
                            <h2 class="step-title">What’s your name?</h2>
                        </div>
                        <form id="horoscopeForm">
                            <div class="form-group mb-4">
                                <input type="text" class="form-control form-input" id="name" name="name" placeholder="Enter your full name" required>
                            </div>
                            <p class="fs-12 mt-3 text-center text-white onest-font">Private &nbsp; &nbsp;  Takes less than 1 minute</p>
                        </form>
                    </div>  

                    <!-- Step 2: Gender Selection -->
                    <div class="step-content" id="step2" style="display: none;">
                        <div class="form-header text-center mb-4">
                            <h2 class="step-title">Select Your Gender</h2>
                        </div>
                        <div class="gender-selection">
                            <button type="button" class="gender-btn" id="gender-male" onclick="selectGenderStep2('male')">
                                <div class="gender-icon">♂</div>
                                <span class="gender-label">Male</span>
                            </button>
                            <button type="button" class="gender-btn" id="gender-female" onclick="selectGenderStep2('female')">
                                <div class="gender-icon">♀</div>
                                <span class="gender-label">Female</span>
                            </button>
                            <button type="button" class="gender-btn" id="gender-other" onclick="selectGenderStep2('other')">
                                <div class="gender-icon">⚥</div>
                                <span class="gender-label">Other</span>
                            </button>
                        </div>
                    </div>

                    <!-- Step 3: WhatsApp Number -->
                    <div class="step-content" id="step3" style="display: none;">
                        <div class="form-header text-center mb-4">
                            <h2 class="step-title">WhatsApp Number</h2>
                        </div>
                        <form>
                            <div class="form-group mb-4">
                                <input type="tel" class="form-control form-input" id="whatsapp" name="whatsapp" placeholder="Enter your 10-digit WhatsApp number" ">
                              
                            </div>
                        </form>
                    </div>

                    <!-- Step 4: Place of Birth -->
                    <div class="step-content" id="step4" style="display: none;">
                        <div class="form-header text-center mb-4">
                            <h2 class="step-title">Where were you born?</h2>
                        </div>
                        <form>
                            <div class="form-group mb-4">
                                <select class="form-control form-input" id="stateOfBirth" name="stateOfBirth" required>
                                    <option value="">Select State</option>
                                    <option value="Andhra Pradesh">Andhra Pradesh</option>
                                    <option value="Arunachal Pradesh">Arunachal Pradesh</option>
                                    <option value="Assam">Assam</option>
                                    <option value="Bihar">Bihar</option>
                                    <option value="Chhattisgarh">Chhattisgarh</option>
                                    <option value="Goa">Goa</option>
                                    <option value="Gujarat">Gujarat</option>
                                    <option value="Haryana">Haryana</option>
                                    <option value="Himachal Pradesh">Himachal Pradesh</option>
                                    <option value="Jharkhand">Jharkhand</option>
                                    <option value="Karnataka">Karnataka</option>
                                    <option value="Kerala">Kerala</option>
                                    <option value="Madhya Pradesh">Madhya Pradesh</option>
                                    <option value="Maharashtra">Maharashtra</option>
                                    <option value="Manipur">Manipur</option>
                                    <option value="Meghalaya">Meghalaya</option>
                                    <option value="Mizoram">Mizoram</option>
                                    <option value="Nagaland">Nagaland</option>
                                    <option value="Odisha">Odisha</option>
                                    <option value="Punjab">Punjab</option>
                                    <option value="Rajasthan">Rajasthan</option>
                                    <option value="Sikkim">Sikkim</option>
                                    <option value="Tamil Nadu">Tamil Nadu</option>
                                    <option value="Telangana">Telangana</option>
                                    <option value="Tripura">Tripura</option>
                                    <option value="Uttar Pradesh">Uttar Pradesh</option>
                                    <option value="Uttarakhand">Uttarakhand</option>
                                    <option value="West Bengal">West Bengal</option>
                                    <option value="Andaman and Nicobar Islands">Andaman and Nicobar Islands</option>
                                    <option value="Chandigarh">Chandigarh</option>
                                    <option value="Dadra and Nagar Haveli and Daman and Diu">Dadra and Nagar Haveli and Daman and Diu</option>
                                    <option value="Delhi">Delhi</option>
                                    <option value="Jammu and Kashmir">Jammu and Kashmir</option>
                                    <option value="Ladakh">Ladakh</option>
                                    <option value="Lakshadweep">Lakshadweep</option>
                                    <option value="Puducherry">Puducherry</option>
                                </select>
                            </div>
                            <div class="form-group mb-4">
                                <input type="text" class="form-control form-input" id="cityOfBirth" name="cityOfBirth" placeholder="Enter City" required>
                            </div>
                        </form>
                    </div>

                    <!-- Step 5: Date of Birth -->
                    <div class="step-content" id="step5" style="display: none;">
                        <div class="form-header text-center mb-4">
                            <h2 class="step-title">Date of Birth</h2>
                        </div>
                        <form>
                            <div class="form-group mb-4">
                                <input type="date" class="form-control form-input" id="dateOfBirth" name="dateOfBirth" required>
                            </div>
                        </form>
                    </div>

                    <!-- Step 6: Time of Birth -->
                    <div class="step-content" id="step6" style="display: none;">
                        <div class="form-header text-center mb-4">
                            <h2 class="step-title">What time were you born?</h2>
                        </div>
                        <form>
                            <div class="form-group mb-4">
                                <div class="d-flex align-items-center justify-content-between gap-3">
                                    <!-- Hour Select -->
                                    <select class="form-control form-input time-select" id="hourOfBirth" name="hourOfBirth" required style="width: auto; min-width: 85px;text-align: center;
    padding: 12px 0px !important;">
                                        <option value="">Hour</option>
                                        <option value="1">1</option>
                                        <option value="2">2</option>
                                        <option value="3">3</option>
                                        <option value="4">4</option>
                                        <option value="5">5</option>
                                        <option value="6">6</option>
                                        <option value="7">7</option>
                                        <option value="8">8</option>
                                        <option value="9">9</option>
                                        <option value="10">10</option>
                                        <option value="11">11</option>
                                        <option value="12">12</option>
                                    </select>
                                    
                                    <span class="text-white" style="font-size: 20px;">:</span>
                                    
                                    <!-- Minute Select -->
                                    <select class="form-control form-input time-select" id="minuteOfBirth" name="minuteOfBirth" required style="width: auto; min-width: 85px;text-align: center;
    padding: 12px 0px !important;">
                                        <option value="">Min</option>
                                        <option value="00">00</option>
                                        <option value="01">01</option>
                                        <option value="02">02</option>
                                        <option value="03">03</option>
                                        <option value="04">04</option>
                                        <option value="05">05</option>
                                        <option value="06">06</option>
                                        <option value="07">07</option>
                                        <option value="08">08</option>
                                        <option value="09">09</option>
                                        <option value="10">10</option>
                                        <option value="11">11</option>
                                        <option value="12">12</option>
                                        <option value="13">13</option>
                                        <option value="14">14</option>
                                        <option value="15">15</option>
                                        <option value="16">16</option>
                                        <option value="17">17</option>
                                        <option value="18">18</option>
                                        <option value="19">19</option>
                                        <option value="20">20</option>
                                        <option value="21">21</option>
                                        <option value="22">22</option>
                                        <option value="23">23</option>
                                        <option value="24">24</option>
                                        <option value="25">25</option>
                                        <option value="26">26</option>
                                        <option value="27">27</option>
                                        <option value="28">28</option>
                                        <option value="29">29</option>
                                        <option value="30">30</option>
                                        <option value="31">31</option>
                                        <option value="32">32</option>
                                        <option value="33">33</option>
                                        <option value="34">34</option>
                                        <option value="35">35</option>
                                        <option value="36">36</option>
                                        <option value="37">37</option>
                                        <option value="38">38</option>
                                        <option value="39">39</option>
                                        <option value="40">40</option>
                                        <option value="41">41</option>
                                        <option value="42">42</option>
                                        <option value="43">43</option>
                                        <option value="44">44</option>
                                        <option value="45">45</option>
                                        <option value="46">46</option>
                                        <option value="47">47</option>
                                        <option value="48">48</option>
                                        <option value="49">49</option>
                                        <option value="50">50</option>
                                        <option value="51">51</option>
                                        <option value="52">52</option>
                                        <option value="53">53</option>
                                        <option value="54">54</option>
                                        <option value="55">55</option>
                                        <option value="56">56</option>
                                        <option value="57">57</option>
                                        <option value="58">58</option>
                                        <option value="59">59</option>
                                    </select>
                                    
                                    <!-- AM/PM Select -->
                                    <select class="form-control form-input time-select" id="ampmOfBirth" name="ampmOfBirth" required style="width: auto; text-align: center;
    padding: 12px 0px !important;min-width: 80px;">
                                        <option value="">AM/PM</option>
                                        <option value="AM">AM</option>
                                        <option value="PM">PM</option>
                                    </select>
                                </div>
                                <!-- Hidden input to store 24-hour format time -->
                                <input type="hidden" id="timeOfBirth" name="timeOfBirth">
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Fixed Bottom Button Container -->
    <div class="fixed-bottom-button" id="fixedBottomButton">
        <p class="fs-12 text-center text-tertiary onest-font">
            Created by the best vedic astrologers of the country. Get detailed report at ₹299
        </p>
        <div class="container">
            <div class="row justify-content-center">
                <div class="col-lg-8 col-md-10">
                    <div class="form-actions-bottom">
                        <button type="button" class="btn primary-custom" id="nextButton" onclick="nextStep()">Next 
                            <img src="assets/images/arrow-r.svg" alt="Banner" class="img-fluid ms-2">
                        </button>
                        <button type="submit" class="btn primary-custom" id="submitButton" onclick="submitForm(event)" style="display: none;">Submit <i class="bi bi-check-circle"></i></button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentStep = 1;
        const totalSteps = 6;

        function updateProgress() {
            // Calculate progress percentage based on current step
            // Step 1 = 16.67%, Step 2 = 33.33%, Step 3 = 50%, Step 4 = 66.67%, Step 5 = 83.33%, Step 6 = 100%
            const progress = (currentStep / totalSteps) * 100;
            const progressBar = document.getElementById('progressBar');
            if (progressBar) {
                progressBar.style.width = progress + '%';
                // Update aria attributes for accessibility
                progressBar.setAttribute('aria-valuenow', currentStep);
                progressBar.setAttribute('aria-valuemin', 1);
                progressBar.setAttribute('aria-valuemax', totalSteps);
            }
        }

        function showStep(step) {
            // Hide all steps
            for (let i = 1; i <= totalSteps; i++) {
                document.getElementById('step' + i).style.display = 'none';
            }
            
            // Show current step
            document.getElementById('step' + step).style.display = 'block';
            
            // Show/hide back button
            if (step >= 1) {
                document.getElementById('backButton').style.display = 'block';
            } 
            
            // Update step count
            document.getElementById('stepCount').textContent = `${step}/${totalSteps}`;
            
            // Show/hide next and submit buttons
            if (step === totalSteps) {
                document.getElementById('nextButton').style.display = 'none';
                document.getElementById('submitButton').style.display = 'block';
            } else {
                document.getElementById('nextButton').style.display = 'block';
                document.getElementById('submitButton').style.display = 'none';
            }
            
            // If showing step 2, highlight previously selected gender if any
            if (step === 2) {
                highlightSelectedGender();
            }
            
            updateProgress();
        }

        function nextStep() {
            // Special validation for step 2 (gender selection)
            if (currentStep === 2) {
                if (!selectedGender) {
                    // Show error message
                    Swal.fire({
                        icon: 'warning',
                        title: 'Gender Required',
                        text: 'Please select your gender to continue.',
                        confirmButtonColor: '#5F9598',
                        confirmButtonText: 'OK'
                    });
                    return;
                }
            }
            
            // Validate current step
            const currentStepElement = document.getElementById('step' + currentStep);
            const input = currentStepElement.querySelector('input[required]');
            
            if (input && !input.value.trim()) {
                input.classList.add('is-invalid');
                return;
            }
            
            // Special validation for WhatsApp number (step 3) - must be exactly 10 digits
           /*  if (currentStep === 3) {
                const whatsappInput = document.getElementById('whatsapp');
                const whatsappValue = whatsappInput.value.trim().replace(/\D/g, ''); 
                
               
            }
             */
            if (currentStep < totalSteps) {
                currentStep++;
                showStep(currentStep);
            }
        }

        function previousStep() {
            if (currentStep > 1) {
                currentStep--;
                showStep(currentStep);
            } else if (currentStep === 1) {
                // If on step 1, go back to index page
                window.location.href = 'index.html';
            }
        }

        // Store form data globally to use after payment
        let formDataToStore = {};
        let selectedGender = '';

        function selectGender(gender) {
            selectedGender = gender;
            console.log('Gender selected:', gender);
            // Hide landing page
            document.getElementById('landingPage').style.display = 'none';
            // Show form section
            document.getElementById('formSection').style.display = 'block';
            // Show fixed bottom button
            document.getElementById('fixedBottomButton').style.display = 'block';
            // Start with step 1
            currentStep = 1;
            showStep(1);
        }

        function selectGenderStep2(gender) {
            selectedGender = gender;
            console.log('Gender selected in step 2:', gender);
            highlightSelectedGender();
        }

        function highlightSelectedGender() {
            // Remove active class from all gender buttons
            document.querySelectorAll('.gender-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Add active class to selected gender button
            if (selectedGender) {
                const selectedButton = document.getElementById('gender-' + selectedGender);
                if (selectedButton) {
                    selectedButton.classList.add('active');
                }
            }
        }

        // Convert AM/PM time to 24-hour format
        function convertTo24Hour(hour, minute, ampm) {
            if (!hour || !minute || !ampm) {
                return '';
            }
            
            let hour24 = parseInt(hour);
            const minute24 = minute.padStart(2, '0');
            
            if (ampm === 'PM' && hour24 !== 12) {
                hour24 += 12;
            } else if (ampm === 'AM' && hour24 === 12) {
                hour24 = 0;
            }
            
            return `${hour24.toString().padStart(2, '0')}:${minute24}`;
        }

        // Update hidden timeOfBirth field when time selects change
        function updateTimeOfBirth() {
            const hour = document.getElementById('hourOfBirth').value;
            const minute = document.getElementById('minuteOfBirth').value;
            const ampm = document.getElementById('ampmOfBirth').value;
            const timeOfBirthInput = document.getElementById('timeOfBirth');
            
            if (hour && minute && ampm) {
                timeOfBirthInput.value = hour + ':' + minute + ' ' + ampm;
               /*  const time24 = convertTo24Hour(hour, minute, ampm);
                timeOfBirthInput.value = time24; */
            } else {
                timeOfBirthInput.value = '';
            }
        }

        async function submitForm(event) {
            event.preventDefault();
            
            // Validate last step - check if all time fields are filled
            const hour = document.getElementById('hourOfBirth').value;
            const minute = document.getElementById('minuteOfBirth').value;
            const ampm = document.getElementById('ampmOfBirth').value;
            
            if (!hour || !minute || !ampm) {
                // Show error message
                Swal.fire({
                    icon: 'warning',
                    title: 'Time Required',
                    text: 'Please select hour, minute, and AM/PM to continue.',
                    confirmButtonColor: '#5F9598',
                    confirmButtonText: 'OK'
                });
                return;
            }
            
            // Update the hidden timeOfBirth field
            updateTimeOfBirth();
            
            // Collect all form data
            const stateOfBirth = document.getElementById('stateOfBirth').value;
            const cityOfBirth = document.getElementById('cityOfBirth').value;

        //    const timeOfBirth = document.getElementById('timeOfBirth').value + ' ' + document.getElementById('ampmOfBirth').value;
            
            formDataToStore = {
                gender: selectedGender || '',
                name: document.getElementById('name').value,
                whatsapp: document.getElementById('whatsapp').value,
                stateOfBirth: stateOfBirth,
                cityOfBirth: cityOfBirth,
                dateOfBirth: document.getElementById('dateOfBirth').value,
                timeOfBirth: document.getElementById('timeOfBirth').value,
                payment_status: 'pending',
                created_at: new Date().toISOString()
            };
            
            // Console log the data
            console.log('Form Data Submitted:', formDataToStore);
            
            // Show loading spinner
            Swal.fire({
                title: 'Saving your information...',
                html: 'Please wait while we save your data.',
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });
            
            // First, save data to Firebase
            try {
                if (window.firestoreDb) {
                    console.log('Form data to store:', formDataToStore);
                    const docRef = await window.firestoreDb.collection('horoscope_submissions').add(formDataToStore);
                    const documentId = docRef.id;
                    
                    console.log('Data saved to Firebase with ID:', documentId);
                    
                    // Close loading and proceed with payment
                    Swal.close();
                    
                    // Prepare payment booking with document ID
                    initiatePayment(documentId);
                } else {
                    // Retry after a short delay if Firebase not ready
                    setTimeout(() => submitForm(event), 1000);
                }
            } catch (error) {
                console.error('Error saving to Firebase:', error);
                Swal.close();
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'Failed to save your information. Please try again.',
                    confirmButtonColor: '#5F9598',
                    confirmButtonText: 'OK'
                });
            }
        }

        function initiatePayment(documentId) {
            // Set package type
            const packageType = 'Hast Rekha'; //horoscope
            
            // Set success redirect URL to successpage.html with document ID
            const baseUrl = window.location.origin;
            const currentPath = window.location.pathname;
            const directoryPath = currentPath.substring(0, currentPath.lastIndexOf('/'));
            const successRedirectUrl = baseUrl + (directoryPath ? directoryPath : '') + '/successpage.html?doc_id=' + encodeURIComponent(documentId);
            
            // Show loading spinner
            Swal.fire({
                title: 'Processing your booking...',
                html: 'Please wait while we process your request.',
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });

            // Prepare form data for payment API
            const paymentFormData = new URLSearchParams();
            paymentFormData.append('package-type', packageType);
            paymentFormData.append('success_redirect_url', successRedirectUrl);
            
            console.log("Payment form data:", paymentFormData.toString());
            console.log("Success redirect URL:", successRedirectUrl);

            // Submit to payment API
            axios.post('https://sanatanis.app/mainajaxcalls/main/book', paymentFormData.toString(), {
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded'
                }
            })
                .then(function (response) {
                    if (response.data.success_msg) {
                        const responseData = response.data.data;

                        if (responseData && responseData.redirect_url) {
                            // Redirect to the payment page
                            // Document ID is already stored in sessionStorage from submitForm
                            window.location.href = responseData.redirect_url;
                        } else {
                            Swal.close();
                            Swal.fire({
                                icon: 'error',
                                title: 'Booking Failed',
                                text: response.data.errors[0] || 'Something went wrong. Please try again later.',
                                confirmButtonColor: '#5F9598',
                                confirmButtonText: 'OK'
                            });
                        }
                    } else {
                        Swal.close();
                        Swal.fire({
                            icon: 'error',
                            title: 'Booking Failed',
                            text: response.data.message || 'Something went wrong. Please try again later.',
                            confirmButtonColor: '#5F9598',
                            confirmButtonText: 'OK'
                        });
                    }
                })
                .catch(function (error) {
                    console.error('Error:', error);
                    Swal.close();
                    Swal.fire({
                        icon: 'error',
                        title: 'Booking Failed',
                        text: 'An error occurred while processing your request. Please try again later.',
                        confirmButtonColor: '#5F9598',
                        confirmButtonText: 'OK'
                    });
                });
        }

        // Handle payment success callback
        async function handlePaymentSuccess() {
            // Get URL parameters
            const urlParams = new URLSearchParams(window.location.search);
            const paymentSuccess = urlParams.get('payment_success');
            const paymentId = urlParams.get('payment_id') || 
                             urlParams.get('razorpay_payment_id') || 
                             urlParams.get('transaction_id') ||
                             urlParams.get('paymentId') ||
                             urlParams.get('txnid');
            const orderId = urlParams.get('order') || 
                           urlParams.get('order_id') || 
                           urlParams.get('razorpay_order_id') || 
                           urlParams.get('orderId') ||
                           urlParams.get('orderid');
            
            // Check if payment was successful (either by parameter or by having payment/order IDs)
            if (paymentSuccess === 'true' || paymentId || orderId) {
                // Get stored Firebase document ID
                const documentId = sessionStorage.getItem('firebaseDocId');
                
                if (!documentId) {
                    console.error('Firebase document ID not found in sessionStorage');
                    Swal.fire({
                        icon: 'warning',
                        title: 'Payment Successful',
                        text: 'Payment confirmed but document ID not found. Please contact support.',
                        confirmButtonColor: '#5F9598',
                        confirmButtonText: 'OK'
                    });
                    return;
                }
                
                // Prepare payment update data
                const paymentUpdateData = {
                    payment_id: paymentId || '',
                    order: orderId || '',
                    payment_date: new Date().toISOString(),
                    payment_status: (paymentId || orderId) ? 'success' : 'pending',
                    updated_at: new Date().toISOString()
                };
                
                console.log('Updating Firebase document:', documentId, 'with payment data:', paymentUpdateData);
                
                // Update Firebase document with payment information
                try {
                    // Wait for Firebase to be ready
                    if (window.firestoreDb) {
                        await window.firestoreDb.collection('horoscope_submissions').doc(documentId).update(paymentUpdateData);
                        
                        console.log('Payment data updated in Firebase successfully');
                        
                        // Redirect to success page
                        window.location.href = 'successpage.html';
                    } else {
                        // Retry after a short delay if Firebase not ready
                        setTimeout(handlePaymentSuccess, 1000);
                    }
                } catch (error) {
                    console.error('Error updating Firebase document:', error);
                    Swal.fire({
                        icon: 'warning',
                        title: 'Payment Successful',
                        text: 'Payment confirmed but there was an issue updating the record. Please contact support.',
                        confirmButtonColor: '#5F9598',
                        confirmButtonText: 'OK'
                    });
                }
            }
        }

        // Initialize - Show step 1 on page load
        document.getElementById('backButton').addEventListener('click', previousStep);
        
        // Check for payment success on page load or show step 1 initially
        window.addEventListener('DOMContentLoaded', function() {
            const urlParams = new URLSearchParams(window.location.search);
            const paymentSuccess = urlParams.get('payment_success');
            // Only handle payment success if we're on this page (fallback scenario)
            if (paymentSuccess === 'true') {
                setTimeout(handlePaymentSuccess, 500);
                return;
            }
            
            // Add event listeners for time selects
            const hourSelect = document.getElementById('hourOfBirth');
            const minuteSelect = document.getElementById('minuteOfBirth');
            const ampmSelect = document.getElementById('ampmOfBirth');
            
            if (hourSelect) {
                hourSelect.addEventListener('change', updateTimeOfBirth);
            }
            if (minuteSelect) {
                minuteSelect.addEventListener('change', updateTimeOfBirth);
            }
            if (ampmSelect) {
                ampmSelect.addEventListener('change', updateTimeOfBirth);
            }
            
            // Otherwise, show step 1 initially
            currentStep = 1;
            showStep(1);
        });
    </script>
</body>
</html>