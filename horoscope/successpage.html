<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Payment Successful</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCImREVr-D4ZUr3kPk0rVqztnfcgFge0P8",
            authDomain: "horoscope-81d33.firebaseapp.com",
            projectId: "horoscope-81d33",
            storageBucket: "horoscope-81d33.firebasestorage.app",
            messagingSenderId: "714864410936",
            appId: "1:714864410936:web:57b90523d5d350b7c4c1cd"
        };
        
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        
        window.firestoreDb = db;
    </script>
    <!-- Meta Pixel Code -->
<script>
!function(f,b,e,v,n,t,s)
{if(f.fbq)return;n=f.fbq=function(){n.callMethod?
n.callMethod.apply(n,arguments):n.queue.push(arguments)};
if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
n.queue=[];t=b.createElement(e);t.async=!0;
t.src=v;s=b.getElementsByTagName(e)[0];
s.parentNode.insertBefore(t,s)}(window, document,'script',
'https://connect.facebook.net/en_US/fbevents.js');
fbq('init', '806488919150102');
fbq('track', 'PageView');
</script>
<noscript><img height="1" width="1" style="display:none"
src="https://www.facebook.com/tr?id=806488919150102&ev=PageView&noscript=1"
/></noscript>
<!-- End Meta Pixel Code -->
    <style>
  
.success-message{
    background: #FFFFFF1A;
   padding: 20px;
   border-radius: 8px;
}
.content-wrapper{
    position: relative;
    z-index: 9;
    .chart{
        text-align: center;
        display: flex;
        justify-content: center;
    .birth-chart-img{
        width: 70%;
}
}
}

.whatsapp-box{
    border: 1px solid #4D4C4C;
    padding: 10px;
    border-radius: 8px;
    .whatsapp-box-inner{
        display: flex;
    align-items: start;
    gap: 10px;
    p{
        margin-bottom: 0px;
        font-size: 14px;
    }
    }
}
.deep-insights-box{
    background: #FFFFFF0A;
    padding: 10px;
    border: 1px solid #4D4C4C;
    border-radius: 8px;
    h5{
        font-size: 16px;
        font-weight: 500;
        color: #ffffff;
    }
    p{
        font-weight: 400;
        color: #FFF9EF99;
        font-size: 14px;
    }
}
.line-separator{
    height: 1px;
    width: 100%;
    background: #FFFFFF4D;
    margin-top: 30px;
    margin-bottom: 30px;
}
    </style>
</head>
<body>
    <div class="cosmic-background">
  
    <div class="container">
        <div class="row">
            <div class="col-12 mx-auto col-md-6 col-lg-5">
    <div class="content-wrapper mt-4">

        <div id="loadingContent">
           <p class="text-center text-tertiary onest-font">Loading...</p>
        </div>
        
        <div id="successContent" style="display: none;">
            <div class="birth-chart-container">
                <div class="chart">
                    <img src="assets/images/success.svg" alt="Birth Chart" class="birth-chart-img">
                </div>
            </div> 
            <h2 class="fs-28 mt-3  mb-3 fw-700 text-center title-shadow text-tertiary onest-font">
                Your Horoscope Report is Being Prepared
            </h2>
            <p class="mb-3 fs-14 mx-3 text-center title-shadow text-tertiary onest-font">
                Based on the details you shared, your personalised Vedic horoscope is currently being created.
            </p>
         
            <div class="whatsapp-box">
                <div class="whatsapp-box-inner">
                    <img src="assets/images/whatsapp.svg" alt="WhatsApp" class="whatsapp-img">
                    <p class=" text-tertiary onest-font">
                        Your horoscope report will be sent to your WhatsApp number once itâ€™s ready.
                    </p>
                </div>
            </div>

            <div class="line-separator">
            </div>

              <!-- Fixed Bottom Button Container -->
   <div >
    
    
    <div class="deep-insights-box">
        <h5>Want deeper insights?</h5>
        <p class="fs-12 mb-0  title-shadow-light onest-font mb-2">
            You can also explore Palmistry to understand what your hands reveal about your life, personality, and future.
        </p>
        <div class="form-actions-bottom">
            <button type="button" class="btn primary-custom" 
             onclick="nextStep()">Add Palmistry 
            </button>
        </div>
    </div>
</div>
            
              
        </div>
        
  
    </div>
  

</div>
</div>
</div>

 
</div>
 
    <script>
        function nextStep(){
            window.location.href = 'https://palmreader.web.app/';
        }
        // Handle payment success callback
        async function handlePaymentSuccess() {
            // Get URL parameters
            const urlParams = new URLSearchParams(window.location.search);
            const documentId = urlParams.get('doc_id');
            const paymentId = urlParams.get('payment_id')
            const orderId = urlParams.get('order')
            
            // Check if payment was successful and document ID is present
            if ((paymentId || orderId) && documentId) {
                console.log('Fetching document with ID:', documentId);
                
                try {
                    // Wait for Firebase to be ready
                    if (window.firestoreDb) {
                        // First, fetch the document to get WhatsApp number
                        const docRef = window.firestoreDb.collection('horoscope_submissions').doc(documentId);
                        const docSnap = await docRef.get();
                        
                        if (!docSnap.exists) {
                            console.error('Document not found with ID:', documentId);
                            document.getElementById('loadingContent').style.display = 'none';
                         //   document.getElementById('errorContent').style.display = 'block';
                            return;
                        }
                        
                        const docData = docSnap.data();
                        const whatsappNumber = docData.whatsapp || '-';
                        
                        // Prepare payment update data
                        const paymentUpdateData = {
                            payment_id: paymentId || '',
                            order: orderId || '',
                            payment_date: new Date().toISOString(),
                            payment_status: (paymentId || orderId) ? 'success' : 'pending',
                            updated_at: new Date().toISOString()
                        };
                        
                        console.log('Updating Firebase document:', documentId, 'with payment data:', paymentUpdateData);
                        
                        // Update Firebase document with payment information
                        await docRef.update(paymentUpdateData);
                        
                        console.log('Payment data updated in Firebase successfully');
                        
                        // Show success content
                        document.getElementById('loadingContent').style.display = 'none';
                        document.getElementById('successContent').style.display = 'block';
                        
                        // Display WhatsApp number
                        /* document.getElementById('whatsappNumber').textContent = whatsappNumber; */
                        
                        // Clean URL (remove parameters but keep doc_id for reference if needed)
                        const cleanUrl = window.location.pathname + '?doc_id=' + encodeURIComponent(documentId);
                        window.history.replaceState({}, document.title, cleanUrl);
                    } else {
                        // Retry after a short delay if Firebase not ready
                        setTimeout(handlePaymentSuccess, 1000);
                    }
                } catch (error) {
                    console.error('Error updating Firebase document:', error);
                    document.getElementById('loadingContent').style.display = 'none';
                 // Show success content
                        document.getElementById('successContent').style.display = 'block';
                }
            } else {
                // No payment parameters or document ID found
                console.error('Missing payment parameters or document ID');
                document.getElementById('loadingContent').style.display = 'none';
       // Show success content
                        document.getElementById('successContent').style.display = 'block';
            }
        }

        // Check for payment success on page load
        window.addEventListener('DOMContentLoaded', function() {
            // Small delay to ensure Firebase is initialized
            setTimeout(handlePaymentSuccess, 500);
        });
    </script>
</body>
</html>
