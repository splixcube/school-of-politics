<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Payment Successful</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCImREVr-D4ZUr3kPk0rVqztnfcgFge0P8",
            authDomain: "horoscope-81d33.firebaseapp.com",
            projectId: "horoscope-81d33",
            storageBucket: "horoscope-81d33.firebasestorage.app",
            messagingSenderId: "714864410936",
            appId: "1:714864410936:web:57b90523d5d350b7c4c1cd"
        };
        
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        
        window.firestoreDb = db;
    </script>
    <style>
        .cosmic-background {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 0;
    background-image: url('./assets/images/wrap2.svg');
    .cosmic-background-overlay{
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: radial-gradient(50% 50% at 50% 50%, #5E363F 0%, #232121 100%);
        opacity: .5;
    }
}
.success-message{
    background: #FFFFFF1A;
   padding: 20px;
   border-radius: 8px;
}
.content-wrapper{
    position: relative;
    z-index: 9;
    .birth-chart-img{
        width: 100%;
}
}
    </style>
</head>
<body>
    <div class="cosmic-background">
        <div class="cosmic-background-overlay"></div>
    </div>
    <div class="container">
        <div class="row">
            <div class="col-12 col-md-6 col-lg-5">
    <div class="content-wrapper mt-4">
        <div id="loadingContent">
            <h2 class="fs-28 mb-3 fw-700  text-tertiary onest-font">
                Thank you for sharing your details.
            </h2>
            <p class="mb-3 text-tertiary onest-font">
                We're carefully analysing your information and 
                preparing your personalised Vedic horoscope.
            </p>
            <p class="mb-3 text-tertiary onest-font">
                You'll receive it as soon as it's ready.
            </p>
            <p>Step 3 of 4 - Creating your horoscope.</p>
          <div class="birth-chart-container">
                <div class="chart">
                    <img src="assets/images/success-chart.svg" alt="Birth Chart" class="birth-chart-img">
                </div>
            </div> 
        </div>
        
        <div id="successContent" style="display: none;">
            <h2 class="fs-28 mb-3 fw-700  text-tertiary onest-font">
                Thank you for sharing your details.
            </h2>
            <p class="mb-3 text-tertiary onest-font">
                We're carefully analysing your information and 
                preparing your personalised Vedic horoscope.
            </p>
            <p class="mb-3 text-tertiary onest-font">
                You'll receive it as soon as it's ready.
            </p>
            <p>Step 3 of 4 - Creating your horoscope.</p>
          <div class="birth-chart-container">
                <div class="chart">
                    <img src="assets/images/success-chart.svg" alt="Birth Chart" class="birth-chart-img">
                </div>
            </div> 
            
              
        </div>
        
  
    </div>
  

</div>
</div>
</div>

   <!-- Fixed Bottom Button Container -->
   <div class="fixed-bottom-button" id="fixedBottomButton"  >
    
    
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-lg-8 col-md-10">
                <div class="form-actions-bottom">
                    <button type="button" class="btn primary-custom" 
                     onclick="nextStep()">Add Palmistry 
                    </button>
                </div>
            </div>
        </div>
    </div>
    <div class="d-flex mx-3 mt-2">
        <span>
            ðŸ”’
        </span>
        <p class="fs-12 ms-2 mb-0 text-tertiary onest-font">
            Your information is private and securely handled.
    
        </p>
    </div>
</div>
 
    <script>
        function nextStep(){
            window.location.href = 'https://palmreader.web.app/';
        }
        // Handle payment success callback
        async function handlePaymentSuccess() {
            // Get URL parameters
            const urlParams = new URLSearchParams(window.location.search);
            const documentId = urlParams.get('doc_id');
            const paymentId = urlParams.get('payment_id')
            const orderId = urlParams.get('order')
            
            // Check if payment was successful and document ID is present
            if ((paymentId || orderId) && documentId) {
                console.log('Fetching document with ID:', documentId);
                
                try {
                    // Wait for Firebase to be ready
                    if (window.firestoreDb) {
                        // First, fetch the document to get WhatsApp number
                        const docRef = window.firestoreDb.collection('horoscope_submissions').doc(documentId);
                        const docSnap = await docRef.get();
                        
                        if (!docSnap.exists) {
                            console.error('Document not found with ID:', documentId);
                            document.getElementById('loadingContent').style.display = 'none';
                         //   document.getElementById('errorContent').style.display = 'block';
                            return;
                        }
                        
                        const docData = docSnap.data();
                        const whatsappNumber = docData.whatsapp || '-';
                        
                        // Prepare payment update data
                        const paymentUpdateData = {
                            payment_id: paymentId || '',
                            order: orderId || '',
                            payment_date: new Date().toISOString(),
                            payment_status: (paymentId || orderId) ? 'success' : 'pending',
                            updated_at: new Date().toISOString()
                        };
                        
                        console.log('Updating Firebase document:', documentId, 'with payment data:', paymentUpdateData);
                        
                        // Update Firebase document with payment information
                        await docRef.update(paymentUpdateData);
                        
                        console.log('Payment data updated in Firebase successfully');
                        
                        // Show success content
                        document.getElementById('loadingContent').style.display = 'none';
                        document.getElementById('successContent').style.display = 'block';
                        
                        // Display WhatsApp number
                        /* document.getElementById('whatsappNumber').textContent = whatsappNumber; */
                        
                        // Clean URL (remove parameters but keep doc_id for reference if needed)
                        const cleanUrl = window.location.pathname + '?doc_id=' + encodeURIComponent(documentId);
                        window.history.replaceState({}, document.title, cleanUrl);
                    } else {
                        // Retry after a short delay if Firebase not ready
                        setTimeout(handlePaymentSuccess, 1000);
                    }
                } catch (error) {
                    console.error('Error updating Firebase document:', error);
                    document.getElementById('loadingContent').style.display = 'none';
                 // Show success content
                        document.getElementById('successContent').style.display = 'block';
                }
            } else {
                // No payment parameters or document ID found
                console.error('Missing payment parameters or document ID');
                document.getElementById('loadingContent').style.display = 'none';
       // Show success content
                        document.getElementById('successContent').style.display = 'block';
            }
        }

        // Check for payment success on page load
        window.addEventListener('DOMContentLoaded', function() {
            // Small delay to ensure Firebase is initialized
            setTimeout(handlePaymentSuccess, 500);
        });
    </script>
</body>
</html>
