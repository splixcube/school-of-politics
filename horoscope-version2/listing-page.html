<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Horoscope Submissions Listing</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCImREVr-D4ZUr3kPk0rVqztnfcgFge0P8",
            authDomain: "horoscope-81d33.firebaseapp.com",
            projectId: "horoscope-81d33",
            storageBucket: "horoscope-81d33.firebasestorage.app",
            messagingSenderId: "714864410936",
            appId: "1:714864410936:web:57b90523d5d350b7c4c1cd"
        };
        
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        
        window.firestoreDb = db;
    </script>
    <!-- Meta Pixel Code -->
<script>
    !function(f,b,e,v,n,t,s)
    {if(f.fbq)return;n=f.fbq=function(){n.callMethod?
    n.callMethod.apply(n,arguments):n.queue.push(arguments)};
    if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
    n.queue=[];t=b.createElement(e);t.async=!0;
    t.src=v;s=b.getElementsByTagName(e)[0];
    s.parentNode.insertBefore(t,s)}(window, document,'script',
    'https://connect.facebook.net/en_US/fbevents.js');
    fbq('init', '806488919150102');
    fbq('track', 'PageView');
    </script>
    <noscript><img height="1" width="1" style="display:none"
    src="https://www.facebook.com/tr?id=806488919150102&ev=PageView&noscript=1"
    /></noscript>
    <!-- End Meta Pixel Code -->
    <style>
        .listing-container {
            background: rgba(29, 84, 109, 0.3);
            border-radius: 20px;
            padding: 30px;
            margin-top: 30px;
        }
        .table-container {
            overflow-x: auto;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            background-color: transparent;
        }
      /*   thead {
            background-color: var(--secondary);
        } */
        th {
            color: var(--textcolor);
            padding: 15px;
            text-align: left;
            font-weight: 600;
            border-bottom: 2px solid var(--tertiary);
        }
        td {
            color: var(--textcolor);
            padding: 12px 15px;
            border-bottom: 1px solid rgba(95, 149, 152, 0.3);
        }
        tbody tr:hover {
            background-color: rgba(95, 149, 152, 0.1);
        }
        .loading-spinner {
            text-align: center;
            padding: 50px;
        }
        .no-data {
            text-align: center;
            padding: 50px;
            color: var(--tertiary);
        }
        .page-title {
            color: var(--textcolor);
            margin-bottom: 30px;
            text-align: center;
        }
        .status-badge {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            display: inline-block;
        }
        .status-success {
            background-color: #28a745;
            color: white;
        }
        .status-pending {
            background-color: #ffc107;
            color: #000;
        }
        @media (max-width: 768px) {
            .listing-container {
                padding: 15px;
            }
            table {
                font-size: 14px;
            }
            th, td {
                padding: 8px;
            }
        }
    </style>
</head>
<body>
    <div class="cosmic-background"></div>
    <div class="container wrapper px-3 my-5">
        <div class="row justify-content-center">
            <div class="col-12">
                <h1 class="page-title">Horoscope Data</h1>
                
                <div class="listing-container">
                    <div id="loadingContent" class="loading-spinner">
                        <div class="spinner-border text-light" role="status" style="width: 3rem; height: 3rem;">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-3" style="color: var(--textcolor);">Loading submissions...</p>
                    </div>
                    
                    <div id="tableContent" style="display: none;">
                        <div class="table-container">
                            <table id="submissionsTable">
                                <thead>
                                    <tr>
                                        <th>#</th>
                                        <th>Name</th>
                                        <th>Place of Birth</th>
                                        <th>Date of Birth</th>
                                        <th>Time of Birth</th>
                                        <th>Payment ID</th>
                                        <th>Order</th>
                                        <th>Payment Status</th>
                                        <th>Created At</th>
                                    </tr>
                                </thead>
                                <tbody id="tableBody">
                                    <!-- Data will be inserted here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <div id="noDataContent" class="no-data" style="display: none;">
                        <i class="bi bi-inbox" style="font-size: 48px; opacity: 0.5;"></i>
                        <p class="mt-3">No submissions found</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Format date function
        function formatDate(dateString) {
            if (!dateString) return '-';
            try {
                const date = new Date(dateString);
                return date.toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            } catch (e) {
                return dateString;
            }
        }

        // Format time function
        function formatTime(timeString) {
            if (!timeString) return '-';
            try {
                // If it's just time (HH:MM format)
                if (timeString.includes(':') && timeString.length <= 5) {
                    const [hours, minutes] = timeString.split(':');
                    const hour12 = hours % 12 || 12;
                    const ampm = hours >= 12 ? 'PM' : 'AM';
                    return `${hour12}:${minutes} ${ampm}`;
                }
                return timeString;
            } catch (e) {
                return timeString;
            }
        }

        // Load submissions from Firebase
        async function loadSubmissions() {
            try {
                if (window.firestoreDb) {
                    const snapshot = await window.firestoreDb.collection('horoscope_submissions')
                        .orderBy('created_at', 'desc')
                        .get();
                    
                    const submissions = [];
                    snapshot.forEach((doc) => {
                        submissions.push({
                            id: doc.id,
                            ...doc.data()
                        });
                    });
                    
                    console.log('Loaded submissions:', submissions);
                    
                    // Hide loading, show content
                    document.getElementById('loadingContent').style.display = 'none';
                    
                    if (submissions.length === 0) {
                        document.getElementById('noDataContent').style.display = 'block';
                    } else {
                        document.getElementById('tableContent').style.display = 'block';
                        displaySubmissions(submissions);
                    }
                } else {
                    // Retry after a short delay if Firebase not ready
                    setTimeout(loadSubmissions, 1000);
                }
            } catch (error) {
                console.error('Error loading submissions:', error);
                document.getElementById('loadingContent').style.display = 'none';
                document.getElementById('noDataContent').style.display = 'block';
                document.getElementById('noDataContent').innerHTML = `
                    <i class="bi bi-exclamation-triangle" style="font-size: 48px; opacity: 0.5;"></i>
                    <p class="mt-3">Error loading submissions. Please refresh the page.</p>
                `;
            }
        }

        // Display submissions in table
        function displaySubmissions(submissions) {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';
            
            submissions.forEach((submission, index) => {
                const row = document.createElement('tr');
                
                const paymentStatus = submission.payment_status || 'pending';
                const statusClass = paymentStatus === 'success' ? 'status-success' : 'status-pending';
                const statusText = paymentStatus === 'success' ? 'Success' : 'Pending';
                
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${submission.name || '-'}</td>
                    <td>${submission?.stateOfBirth || ''} ${submission?.stateOfBirth ? ',' : ''} 
                        ${submission?.cityOfBirth || '-'} </td>
                    <td>${submission.dateOfBirth || '-'}</td>
                    <td>${formatTime(submission.timeOfBirth)}</td>
                    <td>${submission.payment_id || '-'}</td>
                    <td>${submission.order || '-'}</td>
                    <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                    <td style="    white-space: nowrap;">${formatDate(submission.created_at)}</td>
                `;
                
                tbody.appendChild(row);
            });
        }

        // Load data on page load
        window.addEventListener('DOMContentLoaded', function() {
            setTimeout(loadSubmissions, 500);
        });
    </script>
</body>
</html>
