<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Horoscope</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
   <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <!-- Axios -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.10.0/axios.min.js"></script>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCImREVr-D4ZUr3kPk0rVqztnfcgFge0P8",
            authDomain: "horoscope-81d33.firebaseapp.com",
            projectId: "horoscope-81d33",
            storageBucket: "horoscope-81d33.firebasestorage.app",
            messagingSenderId: "714864410936",
            appId: "1:714864410936:web:57b90523d5d350b7c4c1cd"
        };
        
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        
        window.firestoreDb = db;
    </script>
<!-- Meta Pixel Code -->
<script>
    !function(f,b,e,v,n,t,s)
    {if(f.fbq)return;n=f.fbq=function(){n.callMethod?
    n.callMethod.apply(n,arguments):n.queue.push(arguments)};
    if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
    n.queue=[];t=b.createElement(e);t.async=!0;
    t.src=v;s=b.getElementsByTagName(e)[0];
    s.parentNode.insertBefore(t,s)}(window, document,'script',
    'https://connect.facebook.net/en_US/fbevents.js');
    fbq('init', '806488919150102');
    fbq('track', 'PageView');
    </script>
    <noscript><img height="1" width="1" style="display:none"
    src="https://www.facebook.com/tr?id=806488919150102&ev=PageView&noscript=1"
    /></noscript>
    <!-- End Meta Pixel Code -->
   <style>
        .home-chart-img{
            width: 80%;
            height: 100%;
            object-fit: contain;
        }
   </style>
</head>
<body>
 <div class="cosmic-background">
 
    
 <div class="container wrapper px-3 py-4" style="max-width: 500px;">
    <div class="row">
        <div class="col-md-12">
            <h2 class="fs-30 fw-700 mb-3  title-shadow text-center onest-font ">
                Horoscope based on your birth  details.
                </h2>
            <p class="fs-12 text-tertiary  title-shadow mb-0 text-center onest-font">
                Know what's ahead. Act at the right time.
            </p>
        </div>
        <div class="col-md-12 mt-3 text-center">
            <img src="assets/images/border.svg" alt="Banner" class="img-fluid">
        </div>
        <div class="col-md-12 text-center mt-3">
            <img src="assets/images/home-chart.svg" alt="Banner" class="home-chart-img">
        </div>

        <div class="col-10 mx-auto mt-5 mb-3">
            <div class="featured-points">
            
                <ul>
                    <li>
                        <img src="assets/images/check.svg" alt="Banner" class="img-fluid">
                        <div>
                            <p class="fs-18 text-tertiary onest-font fw-300 title-shadow">Current Dasha & life Phase</p>
                        </div>
                    </li>
                    <li>
                        <img src="assets/images/check.svg" alt="Banner" class="img-fluid">
                        <div>
                            <p class="fs-18 text-tertiary onest-font fw-300 title-shadow">What’s Blocking You</p>
                        </div>
                    </li>
                    <li>
                        <img src="assets/images/check.svg" alt="Banner" class="img-fluid">
                        <div>
                            <p class="fs-18 text-tertiary onest-font fw-300 title-shadow">Guidance & Remedies</p>
                        </div>
                    </li>
                </ul>
            </div>
        </div>
     <!--    <div class="col-md-12">
            <a href="step-form.html">
            <button type="button" class="btn primary-custom w-100">
                Next 
                <img src="assets/images/arrow-r.svg" alt="Banner" class="img-fluid ms-2">
            </button>
            </a>
        </div> -->
    </div>

 </div>

     <!-- Fixed Bottom Button Container -->
     <div class="fixed-bottom-button" id="fixedBottomButton">
        <div class="container">
            <div class="row justify-content-center">
                <div class="col-12">
                    <p class="fs-12 mb-0 text-center text-tertiary onest-font mb-2">
                        Created by the best vedic astrologers of the country. Get detailed report at ₹299
                    </p>
                    <button type="button" class="btn primary-custom w-100" id="startHoroscopeBtn">
                        Next 
                        <img src="assets/images/arrow-r.svg" alt="Banner" class="img-fluid ms-2">
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

    <!-- Hidden form for payment checkout -->
    <form id="bookNowForm" style="display: none;">
        <input type="hidden" name="package-type" id="package-type">
        <input type="hidden" name="success_redirect_url" id="success-redirect-url">
    </form>

    <script>
        $(document).ready(function () {
            // Handle start horoscope button click
            $("#startHoroscopeBtn").click(function (e) {
                e.preventDefault();
                console.log("Start horoscope button clicked");

                // Set package type
                const packageType = 'horoscope';
                $("#package-type").val(packageType);
                
                // Set success redirect URL to index.html (to handle payment success and create Firebase doc)
                const baseUrl = window.location.origin;
                const currentPath = window.location.pathname;
                // Get directory path (remove filename from path)
                const directoryPath = currentPath.substring(0, currentPath.lastIndexOf('/'));
                const successRedirectUrl = baseUrl + (directoryPath ? directoryPath : '') + '/index.html';
                $("#success-redirect-url").val(successRedirectUrl);
                
                console.log("Package type:", packageType);
                console.log("Success redirect URL:", successRedirectUrl);

                // Submit the form
                $("#bookNowForm").submit();
            });

            // Handle form submission
            $("#bookNowForm").submit(function (e) {
                e.preventDefault();
                
                // Ensure success_redirect_url is set if not already set
                if (!$("#success-redirect-url").val()) {
                    const baseUrl = window.location.origin;
                    const currentPath = window.location.pathname;
                    const directoryPath = currentPath.substring(0, currentPath.lastIndexOf('/'));
                    const successRedirectUrl = baseUrl + (directoryPath ? directoryPath : '') + '/step-form.html';
                    $("#success-redirect-url").val(successRedirectUrl);
                }
                
                const formData = $(this).serialize();
                console.log("Form data being sent:", formData);

                // Show loading spinner
                Swal.fire({
                    title: 'Processing your booking...',
                    html: 'Please wait while we process your request.',
                    allowOutsideClick: false,
                    didOpen: () => {
                        Swal.showLoading();
                    }
                });

                // Submit the form using axios request
                axios.post('https://sanatanis.app/mainajaxcalls/main/book', $(this).serialize())
                    .then(function (response) {
                        if (response.data.success_msg) {
                            const responseData = response.data.data;

                            if (responseData && responseData.redirect_url) {
                                // Redirect to the payment page
                                window.location.href = responseData.redirect_url;
                            } else {
                                // Show error message
                                Swal.fire({
                                    icon: 'error',
                                    title: 'Booking Failed',
                                    text: response.data.errors[0] || 'Something went wrong. Please try again later.',
                                    confirmButtonColor: '#5F9598',
                                    confirmButtonText: 'OK'
                                });
                            }
                        } else {
                            Swal.fire({
                                icon: 'error',
                                title: 'Booking Failed',
                                text: response.data.message || 'Something went wrong. Please try again later.',
                                confirmButtonColor: '#5F9598',
                                confirmButtonText: 'OK'
                            });
                        }
                    })
                    .catch(function (error) {
                        console.error('Error:', error);
                        Swal.fire({
                            icon: 'error',
                            title: 'Booking Failed',
                            text: 'An error occurred while processing your request. Please try again later.',
                            confirmButtonColor: '#5F9598',
                            confirmButtonText: 'OK'
                        });
                    });
            });

            // Handle payment success callback - create Firebase doc and redirect to form
            async function handlePaymentSuccess() {
                // Get URL parameters
                const urlParams = new URLSearchParams(window.location.search);
                const paymentSuccess = urlParams.get('payment_success');
                const paymentId = urlParams.get('payment_id');
                const orderId = urlParams.get('order');
                
                // Check if payment was successful
                if (paymentSuccess === 'true' || paymentId || orderId) {
                    console.log('Payment successful detected');
                    console.log('Payment ID:', paymentId);
                    console.log('Order ID:', orderId);
                    
                    // Show loading
                    Swal.fire({
                        title: 'Processing payment...',
                        html: 'Please wait while we process your payment.',
                        allowOutsideClick: false,
                        didOpen: () => {
                            Swal.showLoading();
                        }
                    });
                    
                    try {
                        // Create Firebase document with payment information
                        const paymentData = {
                            order: orderId || '',
                            payment_id: paymentId || '',
                            payment_date: new Date().toISOString(),
                            payment_status: (paymentId || orderId) ? 'success' : 'pending',
                            created_at: new Date().toISOString()
                        };
                        
                        console.log('Creating Firebase document with payment data:', paymentData);
                        
                        if (window.firestoreDb) {
                            const docRef = await window.firestoreDb.collection('horoscope_submissions').add(paymentData);
                            const documentId = docRef.id;
                            
                            console.log('Firebase document created with ID:', documentId);
                            
                            // Close loading
                            Swal.close();
                            
                            // Redirect to step-form.html with query params
                            const baseUrl = window.location.origin;
                            const currentPath = window.location.pathname;
                            const directoryPath = currentPath.substring(0, currentPath.lastIndexOf('/'));
                            const redirectUrl = baseUrl + (directoryPath ? directoryPath : '') + '/step-form.html' +
                                '?order=' + encodeURIComponent(orderId || '') +
                                '&payment_id=' + encodeURIComponent(paymentId || '') +
                                '&docid=' + encodeURIComponent(documentId);
                            
                            console.log('Redirecting to:', redirectUrl);
                            window.location.href = redirectUrl;
                        } else {
                            // Retry after a short delay if Firebase not ready
                            setTimeout(handlePaymentSuccess, 1000);
                        }
                    } catch (error) {
                        console.error('Error creating Firebase document:', error);
                        Swal.close();
                        Swal.fire({
                            icon: 'error',
                            title: 'Error',
                            text: 'Failed to process payment. Please contact support.',
                            confirmButtonColor: '#5F9598',
                            confirmButtonText: 'OK'
                        });
                    }
                }
            }

            // Check for payment success on page load
            window.addEventListener('DOMContentLoaded', function() {
                const urlParams = new URLSearchParams(window.location.search);
                const paymentSuccess = urlParams.get('payment_success');
                const paymentId = urlParams.get('payment_id') ;
                const orderId = urlParams.get('order') ;
                
                // If payment success parameters exist, handle payment success
                if (paymentSuccess === 'true' || paymentId || orderId) {
                    setTimeout(handlePaymentSuccess, 500);
                }
            });
        });
    </script>
</body>
</html>